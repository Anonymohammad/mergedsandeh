
<script type="text/babel">
function getInventoryData(dateRange) {
    return new Promise(function(resolve, reject) {
        google.script.run.withSuccessHandler(function(allData) {
            var items = allData.items || [];
            var itemMap = {};
            items.forEach(function(it){ itemMap[it.id] = it; });
            var start = dateRange && dateRange.start ? new Date(dateRange.start) : null;
            var end = dateRange && dateRange.end ? new Date(dateRange.end) : null;
            var snapshots = allData.snapshotLogs || [];
            var filtered = snapshots.filter(function(s) {
                var d = new Date(s.date);
                if (start && d < start) return false;
                if (end && d > end) return false;
                return true;
            });
            var dataSource = 'new_tables';
            var categories = {};
            if (filtered.length === 0) {
                dataSource = 'old_tables';
                var tables = ['dailyRawProteins','dailyMarinatedProteins','dailyBreadTracking','dailyHighCostItems'];
                tables.forEach(function(name){
                    var table = allData[name] || [];
                    table.forEach(function(row){
                        var d = row.count_date ? new Date(row.count_date) : null;
                        if (d && (!start || d >= start) && (!end || d <= end)) {
                            for (var key in row) {
                                if (/_remaining$/.test(key)) {
                                    var legacyKey = key.replace('_remaining','');
                                    var item = items.find(function(it){ return it.legacy_key === legacyKey; });
                                    if (item) {
                                        if (!categories[item.category]) categories[item.category] = [];
                                        categories[item.category].push({ name: item.name, quantity: parseFloat(row[key]) || 0, unit: item.unit, date: row.count_date, notes: '', min: item.min_stock, itemId: item.id });
                                    }
                                }
                            }
                        }
                    });
                });
            } else {
                filtered.forEach(function(snap){
                    var item = itemMap[snap.item_id];
                    if (!item) return;
                    if (!categories[item.category]) categories[item.category] = [];
                    categories[item.category].push({ name: item.name, quantity: parseFloat(snap.closing_quantity) || 0, unit: item.unit, date: snap.date, notes: snap.notes || '', min: item.min_stock, itemId: item.id });
                });
            }
            var summary = { totalItems: 0, zeroStock: 0, lowStock: 0, lastUpdated: null };
            Object.keys(categories).forEach(function(cat){
                categories[cat].forEach(function(entry){
                    summary.totalItems++;
                    if (entry.quantity <= 0) summary.zeroStock++;
                    if (entry.min !== undefined && entry.quantity <= parseFloat(entry.min)) summary.lowStock++;
                    if (!summary.lastUpdated || new Date(entry.date) > new Date(summary.lastUpdated)) summary.lastUpdated = entry.date;
                });
            });
            resolve({ dataSource: dataSource, categories: categories, summary: summary });
        }).withFailureHandler(reject).getData();
    });
}

function calculateInventoryMetrics(inventoryData) {
    return new Promise(function(resolve, reject) {
        google.script.run.withSuccessHandler(function(allData) {
            var items = allData.items || [];
            var metrics = { itemsTracked: inventoryData.summary.totalItems, categoryStock: {}, valueByCategory: {}, storageLocations: {}, untrackedItems: 0, totalValue: 0 };
            var itemMapByName = {};
            items.forEach(function(it){ itemMapByName[it.name] = it; });
            Object.keys(inventoryData.categories).forEach(function(cat){
                var qty = 0;
                var val = 0;
                inventoryData.categories[cat].forEach(function(entry){
                    qty += entry.quantity;
                    var item = itemMapByName[entry.name];
                    if (item) {
                        var value = entry.quantity * (parseFloat(item.cost_per_unit) || 0);
                        val += value;
                        var loc = item.storage_location || 'Unknown';
                        if (!metrics.storageLocations[loc]) metrics.storageLocations[loc] = 0;
                        metrics.storageLocations[loc] += entry.quantity;
                    }
                });
                metrics.categoryStock[cat] = qty;
                metrics.valueByCategory[cat] = val;
                metrics.totalValue += val;
            });
            metrics.untrackedItems = items.length - inventoryData.summary.totalItems;
            resolve(metrics);
        }).withFailureHandler(reject).getData();
    });
}

function getInventoryTurnover(categoryFilter, daysPeriod) {
    return new Promise(function(resolve, reject) {
        google.script.run.withSuccessHandler(function(allData) {
            var items = allData.items || [];
            var itemMap = {};
            items.forEach(function(it){ itemMap[it.id] = it; });
            var logs = allData.snapshotLogs || [];
            var now = new Date();
            var start = new Date();
            start.setDate(now.getDate() - (daysPeriod || 30));
            var usage = {};
            logs.forEach(function(log) {
                var d = new Date(log.date);
                if (d < start || d > now) return;
                var item = itemMap[log.item_id];
                if (!item) return;
                if (categoryFilter && item.category !== categoryFilter) return;
                if (!usage[item.id]) usage[item.id] = { first: log.closing_quantity, last: log.closing_quantity, count: 0, total: 0 };
                var u = usage[item.id];
                if (u.count === 0) u.first = log.closing_quantity;
                u.last = log.closing_quantity;
                u.count++;
                u.total += parseFloat(log.closing_quantity) || 0;
            });
            var result = [];
            Object.keys(usage).forEach(function(id) {
                var item = itemMap[id];
                var u = usage[id];
                var avg = u.count > 0 ? u.total / u.count : 0;
                var used = (parseFloat(u.first) || 0) - (parseFloat(u.last) || 0);
                var rate = avg > 0 ? used / avg : 0;
                result.push({ item: item.name, category: item.category, turnover: rate, usage: used, average: avg });
            });
            resolve(result);
        }).withFailureHandler(reject).getData();
    });
}

function getInventoryValue(targetDate) {
    return new Promise(function(resolve, reject) {
        google.script.run.withSuccessHandler(function(allData) {
            var items = allData.items || [];
            var logs = allData.snapshotLogs || [];
            var itemMap = {};
            items.forEach(function(it){ itemMap[it.id] = it; });
            var dateStr = targetDate || new Date().toISOString().split('T')[0];
            var byCategory = {};
            var byLocation = {};
            logs.forEach(function(log){
                if (log.date === dateStr) {
                    var item = itemMap[log.item_id];
                    if (item) {
                        var qty = parseFloat(log.closing_quantity) || 0;
                        var val = qty * (parseFloat(item.cost_per_unit) || 0);
                        if (!byCategory[item.category]) byCategory[item.category] = 0;
                        byCategory[item.category] += val;
                        var loc = item.storage_location || 'Unknown';
                        if (!byLocation[loc]) byLocation[loc] = 0;
                        byLocation[loc] += val;
                    }
                }
            });
            var total = 0;
            Object.keys(byCategory).forEach(function(k){ total += byCategory[k]; });
            resolve({ date: dateStr, totalValue: total, byCategory: byCategory, byLocation: byLocation });
        }).withFailureHandler(reject).getData();
    });
}

function getStockAlerts() {
    return new Promise(function(resolve, reject) {
        google.script.run.withSuccessHandler(function(allData) {
            var items = allData.items || [];
            var logs = allData.snapshotLogs || [];
            var latest = {};
            logs.forEach(function(log){
                var existing = latest[log.item_id];
                if (!existing || new Date(log.date) > new Date(existing.date)) {
                    latest[log.item_id] = { quantity: parseFloat(log.closing_quantity) || 0, date: log.date };
                }
            });
            var alerts = [];
            items.forEach(function(it){
                var l = latest[it.id];
                if (!l) {
                    alerts.push({ type: 'not_tracked', item: it.name, message: 'No recent snapshot' });
                } else {
                    if (l.quantity <= 0) alerts.push({ type: 'zero_stock', item: it.name, message: 'Item out of stock' });
                    else if (it.min_stock && l.quantity <= parseFloat(it.min_stock)) alerts.push({ type: 'low_stock', item: it.name, message: 'Below minimum stock' });
                    var days = Math.floor((new Date().getTime() - new Date(l.date).getTime()) / (1000*60*60*24));
                    if (days > 7) alerts.push({ type: 'not_tracked_recently', item: it.name, message: 'Not tracked in last 7 days' });
                }
            });
            resolve(alerts);
        }).withFailureHandler(reject).getData();
    });
}

function getInventoryTrends(period) {
    return new Promise(function(resolve, reject) {
        google.script.run.withSuccessHandler(function(allData) {
            var items = allData.items || [];
            var logs = allData.snapshotLogs || [];
            var itemMap = {};
            items.forEach(function(it){ itemMap[it.id] = it; });
            var end = new Date();
            var start = new Date();
            start.setDate(end.getDate() - (period || 30));
            var trends = {};
            logs.forEach(function(log){
                var d = new Date(log.date);
                if (d >= start && d <= end) {
                    var item = itemMap[log.item_id];
                    if (item) {
                        if (!trends[log.date]) trends[log.date] = {};
                        if (!trends[log.date][item.category]) trends[log.date][item.category] = 0;
                        trends[log.date][item.category] += parseFloat(log.closing_quantity) || 0;
                    }
                }
            });
            resolve(trends);
        }).withFailureHandler(reject).getData();
    });
}

function ensureDataCompatibility(rawData, sourceType) {
    return { dataSource: sourceType, categories: rawData.categories || {}, summary: rawData.summary || {} };
}

function getDataSourceStatus() {
    return new Promise(function(resolve, reject) {
        google.script.run.withSuccessHandler(function(allData) {
            var newDates = {};
            (allData.snapshotLogs || []).forEach(function(l){ if (l.date) newDates[l.date] = true; });
            var oldDates = {};
            ['dailyRawProteins','dailyMarinatedProteins','dailyBreadTracking','dailyHighCostItems'].forEach(function(name){
                (allData[name] || []).forEach(function(r){ if (r.count_date) oldDates[r.count_date] = true; });
            });
            var total = Object.keys(Object.assign({}, newDates, oldDates)).length;
            var completion = total > 0 ? Math.round(Object.keys(newDates).length / total * 100) : 0;
            resolve({ newTableDates: Object.keys(newDates).length, oldTableDates: Object.keys(oldDates).length, migrationPercent: completion });
        }).withFailureHandler(reject).getData();
    });
}

function ManagementDashboard() {
    const { state } = React.useContext(window.AppContext);
    const [dashboardData, setDashboardData] = React.useState(null);
    const [selectedPeriod, setSelectedPeriod] = React.useState('today');
    const [customDate, setCustomDate] = React.useState('');
    const [alerts, setAlerts] = React.useState([]);
    const [loading, setLoading] = React.useState(true);
    const [cardLoading, setCardLoading] = React.useState({
        metrics: true,
        shawarma: true,
        sales: true,
        inventory: true
    });
    const [showDataStatus, setShowDataStatus] = React.useState(false);
    const [showDebugData, setShowDebugData] = React.useState(false);
    const [inventoryDataState, setInventoryDataState] = React.useState(null);
    const [inventoryMetrics, setInventoryMetrics] = React.useState(null);
    const [inventoryAlerts, setInventoryAlerts] = React.useState([]);

    React.useEffect(() => {
        if (selectedPeriod !== 'custom' || (selectedPeriod === 'custom' && customDate)) {
            loadDashboardData();
        }
    }, [selectedPeriod, customDate]);

    React.useEffect(() => {
        if (dashboardData) {
            getInventoryData({}).then(function(data){
                setInventoryDataState(data);
                return calculateInventoryMetrics(data);
            }).then(function(metrics){
                setInventoryMetrics(metrics);
            });
            getStockAlerts().then(function(alerts){ setInventoryAlerts(alerts); });
        }
    }, [dashboardData]);

    const getAcceptableRemainingRange = (stackWeightKg) => {
        return {
            min: 0.6,
            max: 0.85,
            optimal: Math.min(0.8, stackWeightKg * 0.06)
        };
    };

    const getAcceptableLossRange = () => {
        return { min: 12, max: 28 };
    };

    const getAcceptableTotalWasteRange = (stackWeightKg) => {
        const lossRange = getAcceptableLossRange();
        const remainingRange = getAcceptableRemainingRange(stackWeightKg);
        const minTotalWaste = lossRange.min + (remainingRange.min / stackWeightKg * 100);
        const maxTotalWaste = lossRange.max + (remainingRange.max / stackWeightKg * 100);
        return {
            min: Math.round(minTotalWaste * 10) / 10,
            max: Math.round(maxTotalWaste * 10) / 10
        };
    };

    const computeShawarmaMetrics = (shawarma) => {
        if (!shawarma || !shawarma.starting_weight_kg) return shawarma;

        const startingWeight = parseFloat(shawarma.starting_weight_kg) || 0;
        const remainingWeight = parseFloat(shawarma.remaining_weight_kg) || 0;
        const shavingWeight = parseFloat(shawarma.shaving_weight_kg) || 0;
        const staffMealsWeight = parseFloat(shawarma.staff_meals_weight_kg) || 0;
        const ordersWeight = parseFloat(shawarma.orders_weight_kg) || 0;

        const revenueQar = parseFloat(shawarma.revenue_qar) || 0;


        const lossWeight = startingWeight - (ordersWeight + shavingWeight + staffMealsWeight + remainingWeight);
        const lossPercentage = startingWeight > 0 ? (lossWeight / startingWeight) * 100 : 0;

        const totalWasteWeight = lossWeight + remainingWeight;
        const totalWastePercentage = startingWeight > 0 ? (totalWasteWeight / startingWeight) * 100 : 0;


        const revenuePerKg = ordersWeight > 0 ? revenueQar / ordersWeight : 0;
        const costPerKg = startingWeight > 0 ? (shawarma.stack_cost_qar || 0) / startingWeight : 0;
        const profitPerKg = revenuePerKg - costPerKg;

        return {
            ...shawarma,
            loss_weight_kg: lossWeight,
            loss_percentage: lossPercentage,
            waste_weight_kg: totalWasteWeight,
            waste_percentage: totalWastePercentage,

            revenue_per_kg: revenuePerKg,
            profit_per_kg: profitPerKg,
            total_waste_range: getAcceptableTotalWasteRange(startingWeight),
            remaining_range: getAcceptableRemainingRange(startingWeight)

        };
    };

    const getLowStockThreshold = (category, itemName) => {
        const thresholds = {
            rawProteins: {
                frozen_chicken_breast: 2.0,
                chicken_shawarma: 1.5,
                steak: 1.0,
                marinated_steak: 0.5
            },
            marinatedProteins: {
                fahita_chicken: 1.0,
                chicken_sub: 0.8,
                spicy_strips: 0.5,
                original_strips: 0.5,
                marinated_steak: 0.5
            },
            bread: {
                saj_bread: 20,
                pita_bread: 15,
                bread_roll: 10
            },
            highCostItems: {
                cream: 0.5,
                mayo: 0.3
            }
        }; 
        if (thresholds[category] && thresholds[category][itemName] !== undefined) {
            return thresholds[category][itemName];
        }
        return 1.0;
    };

    const loadDashboardData = async () => {
        if (dashboardData) {
            setCardLoading({
                metrics: true,
                shawarma: true,
                sales: true,
                inventory: true
            });
        } else {
            setLoading(true);
        }

        try {
            let dateParam = null;
            const formatISO = (d) => d.toISOString().split('T')[0];

            if (selectedPeriod === 'custom' && customDate) {
                dateParam = formatISO(new Date(customDate));
            } else if (selectedPeriod === 'today') {
                dateParam = formatISO(new Date());
            } else if (selectedPeriod === 'yesterday') {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                dateParam = formatISO(yesterday);
            } else if (selectedPeriod === 'week' || selectedPeriod === 'month') {
                dateParam = formatISO(new Date());
            }

            console.log("Requesting dashboard data for date:", dateParam);

            const response = await google.script.run
                .withSuccessHandler(data => {
                    console.log("Received dashboard data:", data);
                    try {
                        const parsedData = JSON.parse(data);

                        if (parsedData.shawarma) {
                            parsedData.shawarma = computeShawarmaMetrics(parsedData.shawarma);
                        }

                        if (parsedData.enhanced_analytics) {
                            parsedData.processed_analytics = processEnhancedAnalytics(parsedData.enhanced_analytics);
                        }

                        setDashboardData(parsedData);
                        generateAlerts(parsedData);

                        setLoading(false);
                        setCardLoading({ metrics: false, shawarma: false, sales: false, inventory: false });
                    } catch (parseError) {
                        console.error('Error parsing dashboard data:', parseError);
                        setLoading(false);
                        setCardLoading({ metrics: false, shawarma: false, sales: false, inventory: false });
                    }
                })
                .withFailureHandler(error => {
                    console.error('Error loading dashboard:', error);
                    setLoading(false);
                    setCardLoading({ metrics: false, shawarma: false, sales: false, inventory: false });
                })
                .generateDashboardReport(dateParam, {
                    includeTrends: true,
                    includeComparisons: selectedPeriod !== 'custom',
                    includePettyCashAnalysis: true,
                    includeInventoryAnalysis: true,
                    compareToYesterday: selectedPeriod === 'today'
                });
        } catch (error) {
            console.error('Dashboard error:', error);
            setLoading(false);
            setCardLoading({ metrics: false, shawarma: false, sales: false, inventory: false });
        }
    };

    const processEnhancedAnalytics = (analytics) => {
        const processed = {
            alerts: [],
            recommendations: [],
            insights: []
        };

        if (analytics.pettyCash) {
            processed.petty_cash_summary = {
                total: analytics.pettyCash.total_amount,
                categories: Object.keys(analytics.pettyCash.categories).length,
                top_category: analytics.pettyCash.top_category,
                average: analytics.pettyCash.average_amount
            };

            analytics.pettyCash.recommendations.forEach(rec => {
                processed.recommendations.push({
                    ...rec,
                    source: 'petty_cash'
                });
            });
        }

        if (analytics.inventory) {
            processed.inventory_summary = {
                total_items: analytics.inventory.total_items_tracked,
                low_stock: analytics.inventory.low_stock_items.length,
                zero_stock: analytics.inventory.zero_stock_items.length,
                high_usage: analytics.inventory.high_usage_items.length,
                total_value: analytics.inventory.inventory_value
            };

            analytics.inventory.recommendations.forEach(rec => {
                processed.alerts.push({
                    ...rec,
                    source: 'inventory',
                    type: rec.priority === 'critical' ? 'danger' : rec.priority === 'high' ? 'warning' : 'info'
                });
            });
        }

        if (analytics.sales) {
            processed.sales_summary = {
                quality_score: analytics.sales.performance_metrics.revenue_quality_score,
                payment_diversity: analytics.sales.performance_metrics.payment_method_diversity,
                variance: analytics.sales.payment_breakdown.variance_from_total,
                shawarma_percentage: analytics.sales.performance_metrics.shawarma_percentage
            };

            analytics.sales.recommendations.forEach(rec => {
                processed.recommendations.push({
                    ...rec,
                    source: 'sales'
                });
            });
        }

        return processed;
    };

    const generateAlerts = (data) => {
  const newAlerts = [];

  if (data.shawarma) {
    const lossRange = getAcceptableLossRange();
    const wasteRange = getAcceptableTotalWasteRange(data.shawarma.starting_weight_kg || 0);
    const remainingRange = getAcceptableRemainingRange(data.shawarma.starting_weight_kg || 0);

    if (data.shawarma.loss_percentage > lossRange.max) {
      newAlerts.push({
        type: 'danger',
        icon: '‚ö†Ô∏è',
        title: 'High Cooking Loss',
        message: `Loss is ${data.shawarma.loss_percentage.toFixed(1)}% (max ${lossRange.max}%)`,
        action: 'Review cooking process'
      });
    } else if (data.shawarma.loss_percentage > 25) {
      newAlerts.push({
        type: 'warning',
        icon: '‚ö†Ô∏è',
        title: 'Cooking Loss Above Optimal',
        message: `Loss is ${data.shawarma.loss_percentage.toFixed(1)}%`,
        action: 'Check stack setup'
      });
    }

    if (data.shawarma.waste_percentage > wasteRange.max) {
      newAlerts.push({
        type: 'danger',
        icon: '‚ö†Ô∏è',
        title: 'High Shawarma Waste',
        message: `Waste is ${data.shawarma.waste_percentage.toFixed(1)}% (max ${wasteRange.max.toFixed(1)}%)`,
        action: 'Review cutting techniques and order timing'
      });
    }

    if (data.shawarma.remaining_weight_kg > remainingRange.max) {
      newAlerts.push({
        type: 'danger',
        icon: '‚ö†Ô∏è',
        title: 'High Remaining Weight',
        message: `Remaining ${(data.shawarma.remaining_weight_kg * 1000).toFixed(0)}g (max ${(remainingRange.max * 1000).toFixed(0)}g)`,
        action: 'Adjust cutting or order timing'
      });
    } else if (data.shawarma.remaining_weight_kg > remainingRange.optimal) {
      newAlerts.push({
        type: 'warning',
        icon: '‚ö†Ô∏è',
        title: 'Remaining Weight Above Optimal',
        message: `Remaining ${(data.shawarma.remaining_weight_kg * 1000).toFixed(0)}g (optimal ${(remainingRange.optimal * 1000).toFixed(0)}g)`,
        action: 'Check portion sizes'
      });
    }
  }

  if (data.enhanced_analytics && data.enhanced_analytics.pettyCash) {
    const pettyCash = data.enhanced_analytics.pettyCash;

    if (pettyCash.total_amount > 200) {
      newAlerts.push({
        type: 'warning',
        icon: 'üí≥',
        title: 'High Petty Cash Spending',
        message: `${pettyCash.total_amount.toFixed(2)} QAR spent today`,
        action: 'Review expense necessity and approval process'
      });
    }

    if (pettyCash.categories['Fuel'] && pettyCash.categories['Fuel'].amount > 100) {
      newAlerts.push({
        type: 'info',
        icon: '‚õΩ',
        title: 'High Fuel Expenses',
        message: `${pettyCash.categories['Fuel'].amount.toFixed(2)} QAR on fuel`,
        action: 'Consider delivery route optimization'
      });
    }

    if (pettyCash.entry_count > 8) {
      newAlerts.push({
        type: 'info',
        icon: 'üìù',
        title: 'Many Petty Cash Entries',
        message: `${pettyCash.entry_count} entries today`,
        action: 'Review if some expenses could be planned purchases'
      });
    }
  }

  if (data.processed_analytics && data.processed_analytics.inventory_summary) {
    const inventory = data.processed_analytics.inventory_summary;

    if (inventory.zero_stock > 0) {
      newAlerts.push({
        type: 'danger',
        icon: 'üì¶',
        title: 'Items Out of Stock',
        message: `${inventory.zero_stock} items completely out of stock`,
        action: 'Immediate restocking required'
      });
    }

    if (inventory.low_stock > 5) {
      newAlerts.push({
        type: 'warning',
        icon: 'üìâ',
        title: 'Multiple Low Stock Items',
        message: `${inventory.low_stock} items below minimum levels`,
        action: 'Schedule restocking for low inventory items'
      });
    }

    if (inventory.high_usage > 3) {
      newAlerts.push({
        type: 'info',
        icon: 'üìà',
        title: 'High Usage Detected',
        message: `${inventory.high_usage} items with unusually high usage`,
        action: 'Verify usage accuracy and adjust forecasting'
      });
    }
  }

  if (data.enhanced_analytics && data.enhanced_analytics.sales) {
    const sales = data.enhanced_analytics.sales;

    if (sales.performance_metrics.revenue_quality_score < 60) {
      newAlerts.push({
        type: 'warning',
        icon: 'üìä',
        title: 'Low Revenue Quality Score',
        message: `Quality score: ${sales.performance_metrics.revenue_quality_score.toFixed(0)}/100`,
        action: 'Review payment reconciliation and cost controls'
      });
    }

    if (sales.payment_breakdown.variance_from_total > 20) {
      newAlerts.push({
        type: 'danger',
        icon: 'üí∞',
        title: 'Payment Reconciliation Issue',
        message: `${sales.payment_breakdown.variance_from_total.toFixed(2)} QAR discrepancy`,
        action: 'Verify payment method totals against actual revenue'
      });
    }

    if (sales.performance_metrics.payment_method_diversity < 30) {
      newAlerts.push({
        type: 'info',
        icon: 'üí≥',
        title: 'Low Payment Method Diversity',
        message: `Only ${sales.performance_metrics.payment_method_diversity.toFixed(0)}% payment diversity`,
        action: 'Encourage diverse payment methods for better insights'
      });
    }
  }

  if (data.data_sources) {
    if (data.data_sources.primary_source === 'old_tables') {
      newAlerts.push({
        type: 'info',
        icon: 'üîÑ',
        title: 'Using Legacy Data',
        message: 'Dashboard showing data from old system',
        action: 'Consider migrating this date to new system'
      });
    }

    if (data.data_sources.data_quality && data.data_sources.data_quality.completeness < 80) {
      newAlerts.push({
        type: 'warning',
        icon: '‚ö†Ô∏è',
        title: 'Incomplete Data',
        message: `Only ${data.data_sources.data_quality.completeness}% data completeness`,
        action: 'Review and complete missing data entries'
      });
    }
  }

  setAlerts(newAlerts);
};


    const getAlertColor = (type) => {
        switch (type) {
            case 'danger': return 'border-red-500 bg-red-50 text-red-800';
            case 'warning': return 'border-yellow-500 bg-yellow-50 text-yellow-800';
            case 'success': return 'border-green-500 bg-green-50 text-green-800';
            default: return 'border-blue-500 bg-blue-50 text-blue-800';
        }
    };

    const LoadingCard = ({ children, isLoading }) => {
        if (isLoading) {
            return (
                <div className="bg-white rounded-lg shadow p-6 animate-pulse">
                    <div className="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                    <div className="h-8 bg-gray-200 rounded w-1/2 mb-2"></div>
                    <div className="h-3 bg-gray-200 rounded w-2/3"></div>
                </div>
            );
        }
        return children;
    };

    const SectionLoadingPlaceholder = ({ isLoading, children }) => {
        if (isLoading) {
            return (
                <div className="bg-white rounded-lg shadow p-6 animate-pulse">
                    <div className="h-6 bg-gray-200 rounded w-1/3 mb-4"></div>
                    <div className="space-y-3">
                        <div className="h-4 bg-gray-200 rounded"></div>
                        <div className="h-4 bg-gray-200 rounded w-5/6"></div>
                        <div className="h-4 bg-gray-200 rounded w-4/6"></div>
                    </div>
                </div>
            );
        }
        return children;
    };

    const generateSmartRecommendations = (data) => {
        const recommendations = [];

        if (data.processed_analytics && data.processed_analytics.inventory_summary) {
            const inventory = data.processed_analytics.inventory_summary;
            if (inventory.zero_stock > 0) {
                recommendations.push({
                    priority: 'high',
                    category: 'Inventory',
                    icon: 'üö®',
                    title: 'Critical Stock Shortage',
                    description: `${inventory.zero_stock} items are completely out of stock, potentially impacting sales`,
                    action: 'Emergency restocking required within 24 hours',
                    impact: 'High revenue loss risk'
                });
            }
            if (inventory.low_stock > 3 && inventory.zero_stock === 0) {
                recommendations.push({
                    priority: 'medium',
                    category: 'Inventory',
                    icon: 'üì¶',
                    title: 'Proactive Restocking Needed',
                    description: `${inventory.low_stock} items are running low but still available`,
                    action: 'Schedule restocking within 2-3 days to avoid stockouts',
                    impact: 'Prevent future disruptions'
                });
            }
            if (inventory.total_value > 5000) {
                recommendations.push({
                    priority: 'medium',
                    category: 'Finance',
                    icon: 'üí∞',
                    title: 'High Inventory Value',
                    description: `Current inventory worth ${inventory.total_value.toFixed(0)} QAR`,
                    action: 'Review inventory turnover and consider reducing slow-moving items',
                    impact: 'Optimize cash flow'
                });
            }
            if (inventory.high_usage > 2) {
                recommendations.push({
                    priority: 'low',
                    category: 'Operations',
                    icon: 'üìà',
                    title: 'Review High Usage Items',
                    description: `${inventory.high_usage} items showing unusually high consumption`,
                    action: 'Verify portion sizes and check for waste or theft',
                    impact: 'Cost optimization'
                });
            }
        }

        if (data.enhanced_analytics && data.enhanced_analytics.sales) {
            const sales = data.enhanced_analytics.sales;
            if (sales.performance_metrics.shawarma_percentage < 40) {
                recommendations.push({
                    priority: 'medium',
                    category: 'Marketing',
                    icon: 'ü•ô',
                    title: 'Boost Shawarma Sales',
                    description: `Shawarma only ${sales.performance_metrics.shawarma_percentage.toFixed(1)}% of total sales`,
                    action: 'Consider shawarma promotions or combo deals',
                    impact: 'Increase high-margin product sales'
                });
            }
            if (sales.performance_metrics.food_cost_percentage > 28) {
                recommendations.push({
                    priority: 'high',
                    category: 'Cost Control',
                    icon: 'üí∏',
                    title: 'Food Cost Too High',
                    description: `Food cost at ${sales.performance_metrics.food_cost_percentage.toFixed(1)}%, above 25% target`,
                    action: 'Review portion sizes, reduce waste, negotiate supplier prices',
                    impact: 'Improve profitability'
                });
            }
            if (sales.payment_breakdown.variance_from_total > 10) {
                recommendations.push({
                    priority: 'high',
                    category: 'Finance',
                    icon: 'üîç',
                    title: 'Payment Reconciliation Issue',
                    description: `${sales.payment_breakdown.variance_from_total.toFixed(2)} QAR discrepancy in payment methods`,
                    action: 'Audit cash register and payment processing systems',
                    impact: 'Ensure financial accuracy'
                });
            }
            if (sales.performance_metrics.payment_method_diversity < 50) {
                recommendations.push({
                    priority: 'low',
                    category: 'Technology',
                    icon: 'üí≥',
                    title: 'Promote Digital Payments',
                    description: 'Low payment method diversity limits customer convenience',
                    action: 'Encourage card and mobile payments, check POS functionality',
                    impact: 'Better customer experience and data insights'
                });
            }
        }

        if (data.enhanced_analytics && data.enhanced_analytics.pettyCash) {
            const pettyCash = data.enhanced_analytics.pettyCash;
            if (pettyCash.total_amount > 150) {
                recommendations.push({
                    priority: 'medium',
                    category: 'Expense Control',
                    icon: 'üí≥',
                    title: 'High Petty Cash Spending',
                    description: `${pettyCash.total_amount.toFixed(2)} QAR in petty cash expenses today`,
                    action: 'Review expense approval process and establish daily limits',
                    impact: 'Better expense control'
                });
            }
            if (pettyCash.categories && pettyCash.categories['Fuel'] && pettyCash.categories['Fuel'].amount > 80) {
                recommendations.push({
                    priority: 'low',
                    category: 'Operations',
                    icon: '‚õΩ',
                    title: 'Optimize Delivery Routes',
                    description: `High fuel expenses: ${pettyCash.categories['Fuel'].amount.toFixed(2)} QAR`,
                    action: 'Review delivery routes and consider route optimization software',
                    impact: 'Reduce operational costs'
                });
            }
            if (pettyCash.entry_count > 6) {
                recommendations.push({
                    priority: 'low',
                    category: 'Process',
                    icon: 'üìù',
                    title: 'Streamline Expense Process',
                    description: `${pettyCash.entry_count} separate petty cash entries today`,
                    action: 'Consider bulk purchasing for common items to reduce transactions',
                    impact: 'Administrative efficiency'
                });
            }
        }

        if (data.shawarma) {
            const wastePercentage = data.shawarma.waste_percentage || 0;
            const profitPerKg = data.shawarma.profit_per_kg || 0;
            if (wastePercentage > 30) {
                recommendations.push({
                    priority: 'high',
                    category: 'Operations',
                    icon: 'üóëÔ∏è',
                    title: 'Reduce Shawarma Waste',
                    description: `${wastePercentage.toFixed(1)}% waste is above acceptable range`,
                    action: 'Improve cutting techniques, adjust stack sizes, train staff',
                    impact: 'Increase profitability'
                });
            }
            if (profitPerKg < 8) {
                recommendations.push({
                    priority: 'medium',
                    category: 'Pricing',
                    icon: 'üí∞',
                    title: 'Review Shawarma Pricing',
                    description: `Low profit margin: ${profitPerKg.toFixed(2)} QAR per kg`,
                    action: 'Consider price adjustment or cost reduction strategies',
                    impact: 'Improve margins'
                });
            }
        }

        if (data.data_sources && data.data_sources.primary_source === 'old_tables') {
            recommendations.push({
                priority: 'low',
                category: 'System',
                icon: 'üîÑ',
                title: 'Migrate to New System',
                description: 'Using legacy data format for this date',
                action: 'Migrate historical data to new system for better analytics',
                impact: 'Enhanced reporting capabilities'
            });
        }

        const priorityOrder = { high: 3, medium: 2, low: 1 };
        return recommendations.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
    };

    const calculateRevenuePerformance = (data) => {
        if (!data.sales) return 'No sales data available';
        const revenue = data.sales.total_revenue || 0;
        if (revenue < 300) return 'Below average day';
        if (revenue < 500) return 'Average performance';
        if (revenue < 800) return 'Good performance';
        return 'Excellent performance';
    };

    const calculateCostPerformance = (data) => {
        if (!data.sales || !data.sales.food_cost_percentage) return 'No cost data available';
        const foodCost = data.sales.food_cost_percentage;
        if (foodCost <= 20) return 'Excellent cost control';
        if (foodCost <= 25) return 'Good cost control';
        if (foodCost <= 30) return 'Acceptable cost level';
        return 'Cost control needed';
    };

    const calculateOperationalEfficiency = (data) => {
        if (!data.shawarma) return 'No operational data available';
        const wastePercentage = data.shawarma.waste_percentage || 0;
        const efficiency = 100 - wastePercentage;
        if (efficiency >= 75) return 'Highly efficient operations';
        if (efficiency >= 70) return 'Good operational efficiency';
        if (efficiency >= 65) return 'Acceptable efficiency';
        return 'Efficiency improvements needed';
    };

    const getPerformanceIndicator = (data, type) => {
        switch(type) {
            case 'revenue':
                if (!data.sales) return '';
                const revenue = data.sales.total_revenue || 0;
                return revenue >= 600 ? 'üü¢ Above target' : revenue >= 400 ? 'üü° On track' : 'üî¥ Below target';
            case 'cost':
                if (!data.sales) return '';
                const foodCost = data.sales.food_cost_percentage || 0;
                return foodCost <= 25 ? 'üü¢ Under control' : foodCost <= 30 ? 'üü° Monitor' : 'üî¥ Take action';
            case 'efficiency':
                if (!data.shawarma) return '';
                const waste = data.shawarma.waste_percentage || 0;
                return waste <= 25 ? 'üü¢ Efficient' : waste <= 30 ? 'üü° Good' : 'üî¥ Needs work';
            default:
                return '';
        }
    };

    const createMetricRow = (label, value, status) => {
        const statusColors = {
            excellent: 'text-green-600 bg-green-50',
            good: 'text-blue-600 bg-blue-50',
            needs_improvement: 'text-red-600 bg-red-50',
            unknown: 'text-gray-600 bg-gray-50'
        };
        const statusIcons = {
            excellent: 'üü¢',
            good: 'üü°',
            needs_improvement: 'üî¥',
            unknown: '‚ö™'
        };
        return (
            <div className="flex justify-between items-center p-2 border rounded">
                <span className="text-sm text-gray-700">{label}</span>
                <div className="flex items-center gap-2">
                    <span className="text-sm font-medium">{value}</span>
                    <span className={`text-xs px-2 py-1 rounded-full ${statusColors[status] || statusColors.unknown}`}>{statusIcons[status] || statusIcons.unknown}</span>
                </div>
            </div>
        );
    };

 

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="bg-white rounded-lg shadow p-6">
                <div className="flex justify-between items-center">
                    <div>
                        <h1 className="text-2xl font-bold text-gray-800">Management Dashboard</h1>
                        <p className="text-gray-600">Real-time restaurant performance analytics</p>
                    </div>
                    <div className="flex items-center gap-4">
                        {/* Period Selector */}
                        <select
                            value={selectedPeriod}
                            onChange={e => {
                                setSelectedPeriod(e.target.value);
                                if (e.target.value !== 'custom') {
                                    setCustomDate('');
                                }
                            }}
                            className="px-3 py-2 border rounded focus:ring-2 focus:ring-olive-500"
                        >
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Date</option>
                        </select>
                        
                        {/* Custom Date Input */}
                        {selectedPeriod === 'custom' && (
                            <input
                                type="date"
                                value={customDate}
                                onChange={e => setCustomDate(e.target.value)}
                                className="px-3 py-2 border rounded focus:ring-2 focus:ring-olive-500"
                            />
                        )}
                        
                        <button
                            onClick={loadDashboardData}
                            disabled={cardLoading.metrics || cardLoading.shawarma || cardLoading.sales || cardLoading.inventory}
                            className="bg-olive-600 text-white px-4 py-2 rounded hover:bg-olive-700 disabled:opacity-50 flex items-center gap-2"
                        >
                            {(cardLoading.metrics || cardLoading.shawarma || cardLoading.sales || cardLoading.inventory) && (
                                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                            )}
                            Refresh
                        </button>
                    </div>
                </div>
            </div>

            {/* Alerts Section */}
            {alerts.length > 0 && (
                <div className="space-y-3">
                    <h2 className="text-lg font-semibold text-gray-800">üö® Active Alerts</h2>
                    {alerts.map((alert, index) => (
                        <div key={index} className={`border-l-4 p-4 rounded-lg ${getAlertColor(alert.type)}`}>
                            <div className="flex items-start gap-3">
                                <span className="text-xl">{alert.icon}</span>
                                <div className="flex-1">
                                    <h3 className="font-semibold">{alert.title}</h3>
                                    <p className="text-sm mt-1">{alert.message}</p>
                                    <p className="text-xs mt-2 font-medium">Action: {alert.action}</p>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            )}

            {/* Key Metrics with individual loading */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                {/* Shawarma Profitability */}
                <LoadingCard isLoading={cardLoading.metrics}>
                    <div className="bg-white rounded-lg shadow p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm font-medium text-gray-600">Shawarma Profit/kg</p>
                                <p className="text-2xl font-bold text-green-600">
                                    {dashboardData && dashboardData.shawarma && dashboardData.shawarma.profit_per_kg ? 
                                        `${dashboardData.shawarma.profit_per_kg.toFixed(2)} QAR` : 'N/A'}
                                </p>
                            </div>
                            <div className="text-3xl">ü•ô</div>
                        </div>
                        <div className="mt-4 text-sm text-gray-500">
                            Revenue/kg: {dashboardData && dashboardData.shawarma && dashboardData.shawarma.revenue_per_kg ? 
                                dashboardData.shawarma.revenue_per_kg.toFixed(2) : 'N/A'} QAR
                        </div>
                    </div>
                </LoadingCard>

                {/* Food Cost Percentage */}
                <LoadingCard isLoading={cardLoading.metrics}>
                    <div className="bg-white rounded-lg shadow p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm font-medium text-gray-600">Food Cost %</p>
                                <p className={`text-2xl font-bold ${
                                    ((dashboardData && dashboardData.sales && dashboardData.sales.food_cost_percentage) || 0) > 25 ? 'text-red-600' : 'text-green-600'
                                }`}>
                                    {dashboardData && dashboardData.sales && dashboardData.sales.food_cost_percentage ? 
                                        `${dashboardData.sales.food_cost_percentage.toFixed(1)}%` : 'N/A'}
                                </p>
                            </div>
                            <div className="text-3xl">üí∞</div>
                        </div>
                        <div className="mt-4 text-sm text-gray-500">
                            Target: &lt; 25%
                        </div>
                    </div>
                </LoadingCard>

                {/* Shawarma Waste */}
                <LoadingCard isLoading={cardLoading.metrics}>
                    <div className="bg-white rounded-lg shadow p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm font-medium text-gray-600">Total Waste</p>
                                <p className={`text-2xl font-bold ${
                                    !(dashboardData && dashboardData.shawarma && dashboardData.shawarma.waste_percentage) ? 'text-gray-400' :
                                    dashboardData.shawarma.waste_percentage > (dashboardData.shawarma.total_waste_range ? dashboardData.shawarma.total_waste_range.max : 28) ? 'text-red-600' :
                                    'text-green-600'
                                }`}>
                                    {dashboardData && dashboardData.shawarma && dashboardData.shawarma.waste_percentage ?
                                        `${dashboardData.shawarma.waste_percentage.toFixed(1)}%` : 'N/A'}
                                </p>
                                {dashboardData && dashboardData.shawarma && dashboardData.shawarma.loss_weight_kg !== undefined && (
                                    <p className="text-xs text-gray-600 mt-1">
                                        Loss: {dashboardData.shawarma.loss_weight_kg.toFixed(3)} kg ({dashboardData.shawarma.loss_percentage.toFixed(1)}%)
                                    </p>
                                )}
                            </div>
                            <div className="text-3xl">üóëÔ∏è</div>
                        </div>
                        <div className="mt-4 text-sm text-gray-500">
                            {dashboardData && dashboardData.shawarma && dashboardData.shawarma.total_waste_range ?
                                `Target: ${dashboardData.shawarma.total_waste_range.min.toFixed(1)}-${dashboardData.shawarma.total_waste_range.max.toFixed(1)}%` :
                                'Target: 12-28%'}
                        </div>
                    </div>
                </LoadingCard>

                {/* Daily Revenue */}
                <LoadingCard isLoading={cardLoading.metrics}>
                    <div className="bg-white rounded-lg shadow p-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <p className="text-sm font-medium text-gray-600">Daily Revenue</p>
                                <p className="text-2xl font-bold text-blue-600">
                                    {dashboardData && dashboardData.sales && dashboardData.sales.total_revenue ?
                                        `${dashboardData.sales.total_revenue.toFixed(2)} QAR` : 'N/A'}
                                </p>
                            </div>
                            <div className="text-3xl">üìà</div>
                        </div>
                        <div className="mt-4 text-sm text-gray-500">
                            Orders: {dashboardData && dashboardData.sales && dashboardData.sales.total_orders ?
                                dashboardData.sales.total_orders : 'N/A'}
                        </div>
                    </div>
                </LoadingCard>

                <div className="bg-white rounded-lg shadow-md p-6 border-l-4 border-indigo-500">
                    <div className="flex items-center">
                        <div className="flex-1">
                            <p className="text-sm font-medium text-gray-600">Revenue Quality</p>
                            <p className={`text-2xl font-bold ${
                                (dashboardData && dashboardData.processed_analytics && dashboardData.processed_analytics.sales_summary) ?
                                    (dashboardData.processed_analytics.sales_summary.quality_score >= 80 ? 'text-green-600' :
                                     dashboardData.processed_analytics.sales_summary.quality_score >= 60 ? 'text-yellow-600' : 'text-red-600') :
                                    'text-gray-400'
                            }`}>
                                {(dashboardData && dashboardData.processed_analytics && dashboardData.processed_analytics.sales_summary) ?
                                    `${dashboardData.processed_analytics.sales_summary.quality_score.toFixed(0)}/100` : 'N/A'}
                            </p>
                            <p className="text-xs text-gray-500">Payment accuracy &amp; mix</p>
                        </div>
                        <div className="text-3xl text-indigo-500">üìä</div>
                    </div>
                </div>

                <div className="bg-white rounded-lg shadow-md p-6 border-l-4 border-orange-500">
                    <div className="flex items-center">
                        <div className="flex-1">
                            <p className="text-sm font-medium text-gray-600">Petty Cash Today</p>
                            <p className={`text-2xl font-bold ${
                                (dashboardData && dashboardData.processed_analytics && dashboardData.processed_analytics.petty_cash_summary) ?
                                    (dashboardData.processed_analytics.petty_cash_summary.total > 150 ? 'text-red-600' :
                                     dashboardData.processed_analytics.petty_cash_summary.total > 75 ? 'text-yellow-600' : 'text-green-600') :
                                    'text-gray-400'
                            }`}>
                                {(dashboardData && dashboardData.processed_analytics && dashboardData.processed_analytics.petty_cash_summary) ?
                                    `${dashboardData.processed_analytics.petty_cash_summary.total.toFixed(2)} QAR` : 'N/A'}
                            </p>
                            <p className="text-xs text-gray-500">
                                {(dashboardData && dashboardData.processed_analytics && dashboardData.processed_analytics.petty_cash_summary) ?
                                    `${dashboardData.processed_analytics.petty_cash_summary.categories} categories` : 'No entries'}
                            </p>
                        </div>
                        <div className="text-3xl text-orange-500">üí≥</div>
                    </div>
                </div>

                <div className="bg-white rounded-lg shadow-md p-6 border-l-4 border-teal-500">
                    <div className="flex items-center">
                        <div className="flex-1">
                            <p className="text-sm font-medium text-gray-600">Inventory Health</p>
                            <p className={`text-2xl font-bold ${
                                (dashboardData && dashboardData.processed_analytics && dashboardData.processed_analytics.inventory_summary) ?
                                    (dashboardData.processed_analytics.inventory_summary.zero_stock > 0 ? 'text-red-600' :
                                     dashboardData.processed_analytics.inventory_summary.low_stock > 3 ? 'text-yellow-600' : 'text-green-600') :
                                    'text-gray-400'
                            }`}>
                                {(dashboardData && dashboardData.processed_analytics && dashboardData.processed_analytics.inventory_summary) ?
                                    `${dashboardData.processed_analytics.inventory_summary.low_stock + dashboardData.processed_analytics.inventory_summary.zero_stock}` : 'N/A'}
                            </p>
                            <p className="text-xs text-gray-500">Items needing attention</p>
                        </div>
                        <div className="text-3xl text-teal-500">üì¶</div>
                    </div>
                </div>
            </div>

            {/* Detailed Analytics with individual loading */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Shawarma Analytics */}
                <SectionLoadingPlaceholder isLoading={cardLoading.shawarma}>
                    <div className="bg-white rounded-lg shadow p-6">
                        <h3 className="text-lg font-semibold text-gray-800 mb-4">ü•ô Shawarma Stack Analysis</h3>
                        {dashboardData && dashboardData.shawarma ? (
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span className="text-gray-600">Starting Weight:</span>
                                        <p className="font-medium">{dashboardData.shawarma.starting_weight_kg ? 
                                            dashboardData.shawarma.starting_weight_kg.toFixed(3) : 'N/A'} kg</p>
                                    </div>
                                    <div>
                                        <span className="text-gray-600">Remaining Weight:</span>
                                        <p className={`font-medium ${
                                            dashboardData.shawarma.remaining_range && dashboardData.shawarma.remaining_weight_kg > dashboardData.shawarma.remaining_range.max ? 'text-red-600' :
                                            dashboardData.shawarma.remaining_range && dashboardData.shawarma.remaining_weight_kg > dashboardData.shawarma.remaining_range.optimal ? 'text-yellow-600' : ''
                                        }`}>
                                            {dashboardData.shawarma.remaining_weight_kg ?
                                                dashboardData.shawarma.remaining_weight_kg.toFixed(3) : 'N/A'} kg
                                        </p>
                                        {dashboardData.shawarma.remaining_range && (
                                            <p className="text-xs text-gray-600">Max {(dashboardData.shawarma.remaining_range.max * 1000).toFixed(0)}g</p>
                                        )}
                                    </div>
                                    <div>
                                        <span className="text-gray-600">Orders Weight:</span>
                                        <p className="font-medium">{dashboardData.shawarma.orders_weight_kg ? 
                                            dashboardData.shawarma.orders_weight_kg.toFixed(3) : 'N/A'} kg</p>
                                    </div>
                                    <div>
                                        <span className="text-gray-600">Shaving Weight:</span>
                                        <p className="font-medium">{dashboardData.shawarma.shaving_weight_kg ? 
                                            dashboardData.shawarma.shaving_weight_kg.toFixed(3) : 'N/A'} kg</p>
                                    </div>
                                    <div>
                                        <span className="text-gray-600">Staff Meals:</span>
                                        <p className={`font-medium ${(dashboardData.shawarma.staff_meals_weight_kg || 0) > 0.4 ? 'text-red-600' : 'text-green-600'}`}>
                                            {dashboardData.shawarma.staff_meals_weight_kg ?
                                                dashboardData.shawarma.staff_meals_weight_kg.toFixed(3) : '0.000'} kg
                                        </p>
                                    </div>
                                    <div>
                                        <span className="text-gray-600">Loss Weight:</span>
                                        <p className="font-medium">{dashboardData.shawarma.loss_weight_kg !== undefined ?
                                            dashboardData.shawarma.loss_weight_kg.toFixed(3) : 'N/A'} kg ({dashboardData.shawarma.loss_percentage !== undefined ? dashboardData.shawarma.loss_percentage.toFixed(1) : 'N/A'}%)</p>
                                    </div>
                                    <div>
                                        <span className="text-gray-600">Waste Weight:</span>
                                        <p className="font-medium">{dashboardData.shawarma.waste_weight_kg ?
                                            dashboardData.shawarma.waste_weight_kg.toFixed(3) : 'N/A'} kg</p>
                                    </div>
                                </div>
                                
                                <div className="border-t pt-4">
                                    <h4 className="font-medium text-gray-700 mb-2">Profitability Metrics</h4>
                                    <div className="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <span className="text-gray-600">Revenue per kg:</span>
                                            <p className="font-medium text-green-600">{dashboardData.shawarma.revenue_per_kg ? 
                                                dashboardData.shawarma.revenue_per_kg.toFixed(2) : 'N/A'} QAR</p>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Cost per kg:</span>
                                            <p className="font-medium">{dashboardData.shawarma.starting_weight_kg && dashboardData.shawarma.stack_cost_qar ? 
                                                (dashboardData.shawarma.stack_cost_qar / dashboardData.shawarma.starting_weight_kg).toFixed(2) : 'N/A'} QAR</p>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Profit per kg:</span>
                                            <p className="font-medium text-green-600">{dashboardData.shawarma.profit_per_kg ? 
                                                dashboardData.shawarma.profit_per_kg.toFixed(2) : 'N/A'} QAR</p>
                                        </div>
                                        <div>
                                            <span className="text-gray-600">Total Stack Cost:</span>
                                            <p className="font-medium">{dashboardData.shawarma.stack_cost_qar ? 
                                                dashboardData.shawarma.stack_cost_qar.toFixed(2) : 'N/A'} QAR</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <p className="text-gray-500">No shawarma data available for selected period</p>
                        )}
                    </div>
                </SectionLoadingPlaceholder>

                {/* Sales Performance */}
                <SectionLoadingPlaceholder isLoading={cardLoading.sales}>
                    <div className="bg-white rounded-lg shadow p-6">
                        <h3 className="text-lg font-semibold text-gray-800 mb-4">üìä Enhanced Sales Performance</h3>

                        {dashboardData && dashboardData.sales ? (
                            <div className="space-y-6">
                                <div>
                                    <h4 className="font-medium text-gray-700 mb-3">Revenue Breakdown</h4>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                        <div className="bg-blue-50 p-3 rounded">
                                            <span className="text-gray-600">Total Revenue:</span>
                                            <p className="font-medium text-blue-600 text-lg">{(dashboardData.sales.total_revenue || 0).toFixed(2)} QAR</p>
                                        </div>
                                        <div className="bg-green-50 p-3 rounded">
                                            <span className="text-gray-600">Shawarma:</span>
                                            <p className="font-medium text-green-600 text-lg">{(dashboardData.sales.shawarma_revenue || 0).toFixed(2)} QAR</p>
                                            <p className="text-xs text-gray-500">{((dashboardData.sales.shawarma_revenue || 0) / (dashboardData.sales.total_revenue || 1) * 100).toFixed(1)}%</p>
                                        </div>
                                        <div className="bg-purple-50 p-3 rounded">
                                            <span className="text-gray-600">Other Food:</span>
                                            <p className="font-medium text-purple-600 text-lg">{(dashboardData.sales.other_food_revenue || 0).toFixed(2)} QAR</p>
                                            <p className="text-xs text-gray-500">{((dashboardData.sales.other_food_revenue || 0) / (dashboardData.sales.total_revenue || 1) * 100).toFixed(1)}%</p>
                                        </div>
                                        <div className="bg-orange-50 p-3 rounded">
                                            <span className="text-gray-600">Petty Cash:</span>
                                            <p className="font-medium text-orange-600 text-lg">{(dashboardData.sales.petty_cash_total || 0).toFixed(2)} QAR</p>
                                            <p className="text-xs text-gray-500">{((dashboardData.sales.petty_cash_total || 0) / (dashboardData.sales.total_revenue || 1) * 100).toFixed(1)}%</p>
                                        </div>
                                    </div>
                                </div>

                                {dashboardData.enhanced_analytics && dashboardData.enhanced_analytics.sales && (
                                    <div>
                                        <h4 className="font-medium text-gray-700 mb-3">Payment Methods</h4>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                            {Object.entries(dashboardData.enhanced_analytics.sales.payment_breakdown).map(([method, data]) => {
                                                if (method === 'total_breakdown' || method === 'variance_from_total') return null;
                                                const methodNames = { cash: 'Cash', card: 'Card', delivery_aggregator_1: 'Delivery 1', delivery_aggregator_2: 'Delivery 2' };
                                                return (
                                                    <div key={method} className="border rounded p-2">
                                                        <div className="flex justify-between items-center">
                                                            <span className="text-gray-600 text-xs">{methodNames[method] || method}</span>
                                                            <span className="font-medium">{data.amount.toFixed(2)}</span>
                                                        </div>
                                                        <div className="mt-1">
                                                            <div className="w-full bg-gray-200 rounded-full h-2">
                                                                <div className="bg-blue-600 h-2 rounded-full" style={{ width: `${Math.min(100, data.percentage)}%` }}></div>
                                                            </div>
                                                            <span className="text-xs text-gray-500">{data.percentage.toFixed(1)}%</span>
                                                        </div>
                                                    </div>
                                                );
                                            }).filter(Boolean)}
                                        </div>

                                        {dashboardData.enhanced_analytics.sales.payment_breakdown.variance_from_total > 0 && (
                                            <div className={`mt-3 p-2 rounded text-sm ${
                                                dashboardData.enhanced_analytics.sales.payment_breakdown.variance_from_total > 10 ? 'bg-red-50 text-red-800' :
                                                dashboardData.enhanced_analytics.sales.payment_breakdown.variance_from_total > 2 ? 'bg-yellow-50 text-yellow-800' :
                                                'bg-green-50 text-green-800'
                                            }`}>
                                                <span className="font-medium">Payment Validation: </span>
                                                <span>{dashboardData.enhanced_analytics.sales.payment_breakdown.variance_from_total > 10 ?
                                                    `Large discrepancy: ${dashboardData.enhanced_analytics.sales.payment_breakdown.variance_from_total.toFixed(2)} QAR` :
                                                    dashboardData.enhanced_analytics.sales.payment_breakdown.variance_from_total > 2 ?
                                                    `Small discrepancy: ${dashboardData.enhanced_analytics.sales.payment_breakdown.variance_from_total.toFixed(2)} QAR` :
                                                    'Payments match total revenue'}</span>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {dashboardData.enhanced_analytics && dashboardData.enhanced_analytics.sales && (
                                    <div>
                                        <h4 className="font-medium text-gray-700 mb-3">Performance Metrics</h4>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                            <div className="border rounded p-3">
                                                <span className="text-gray-600">Revenue Quality Score:</span>
                                                <p className={`font-medium text-lg ${
                                                    dashboardData.enhanced_analytics.sales.performance_metrics.revenue_quality_score >= 80 ? 'text-green-600' :
                                                    dashboardData.enhanced_analytics.sales.performance_metrics.revenue_quality_score >= 60 ? 'text-yellow-600' : 'text-red-600'
                                                }`}>
                                                    {dashboardData.enhanced_analytics.sales.performance_metrics.revenue_quality_score.toFixed(0)}/100
                                                </p>
                                            </div>
                                            <div className="border rounded p-3">
                                                <span className="text-gray-600">Payment Diversity:</span>
                                                <p className={`font-medium text-lg ${
                                                    dashboardData.enhanced_analytics.sales.performance_metrics.payment_method_diversity >= 70 ? 'text-green-600' :
                                                    dashboardData.enhanced_analytics.sales.performance_metrics.payment_method_diversity >= 40 ? 'text-yellow-600' : 'text-red-600'
                                                }`}>
                                                    {dashboardData.enhanced_analytics.sales.performance_metrics.payment_method_diversity.toFixed(0)}%
                                                </p>
                                            </div>
                                            <div className="border rounded p-3">
                                                <span className="text-gray-600">Food Cost %:</span>
                                                <p className={`font-medium text-lg ${
                                                    dashboardData.enhanced_analytics.sales.performance_metrics.food_cost_percentage <= 25 ? 'text-green-600' :
                                                    dashboardData.enhanced_analytics.sales.performance_metrics.food_cost_percentage <= 30 ? 'text-yellow-600' : 'text-red-600'
                                                }`}>
                                                    {dashboardData.enhanced_analytics.sales.performance_metrics.food_cost_percentage.toFixed(1)}%
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <p className="text-gray-500">No sales data available for selected period</p>
                        )}
                    </div>
                </SectionLoadingPlaceholder>
            </div>
            {dashboardData && dashboardData.pettyCashEntries && dashboardData.pettyCashEntries.length > 0 && (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">üí≥ Petty Cash Analysis</h3>

                    <div className="space-y-6">
                        {dashboardData.enhanced_analytics && dashboardData.enhanced_analytics.pettyCash && (
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="bg-orange-50 p-4 rounded-lg">
                                    <h4 className="font-medium text-orange-800">Total Amount</h4>
                                    <p className="text-2xl font-bold text-orange-600">{dashboardData.enhanced_analytics.pettyCash.total_amount.toFixed(2)} QAR</p>
                                </div>
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <h4 className="font-medium text-blue-800">Total Entries</h4>
                                    <p className="text-2xl font-bold text-blue-600">{dashboardData.enhanced_analytics.pettyCash.entry_count}</p>
                                </div>
                                <div className="bg-green-50 p-4 rounded-lg">
                                    <h4 className="font-medium text-green-800">Avg Amount</h4>
                                    <p className="text-2xl font-bold text-green-600">{dashboardData.enhanced_analytics.pettyCash.average_amount.toFixed(2)} QAR</p>
                                </div>
                                <div className="bg-purple-50 p-4 rounded-lg">
                                    <h4 className="font-medium text-purple-800">Top Category</h4>
                                    <p className="text-lg font-bold text-purple-600">{dashboardData.enhanced_analytics.pettyCash.top_category || 'N/A'}</p>
                                </div>
                            </div>
                        )}

                        {dashboardData.enhanced_analytics && dashboardData.enhanced_analytics.pettyCash && Object.keys(dashboardData.enhanced_analytics.pettyCash.categories).length > 0 && (
                            <div>
                                <h4 className="font-medium text-gray-700 mb-3">Breakdown by Category</h4>
                                <div className="space-y-2">
                                    {Object.entries(dashboardData.enhanced_analytics.pettyCash.categories).map(([category, data]) => (
                                        <div key={category} className="flex justify-between items-center p-3 bg-gray-50 rounded">
                                            <div className="flex-1">
                                                <span className="font-medium">{category}</span>
                                                <span className="text-sm text-gray-500 ml-2">({data.count} {data.count === 1 ? 'entry' : 'entries'})</span>
                                            </div>
                                            <div className="text-right">
                                                <span className="font-medium text-lg">{data.amount.toFixed(2)} QAR</span>
                                                <div className="text-xs text-gray-500">{((data.amount / dashboardData.enhanced_analytics.pettyCash.total_amount) * 100).toFixed(1)}%</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div>
                            <h4 className="font-medium text-gray-700 mb-3">Recent Entries</h4>
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Category</th>
                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                                            <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Paid By</th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {dashboardData.pettyCashEntries.slice(0,5).map((entry, index) => (
                                            <tr key={index} className="hover:bg-gray-50">
                                                <td className="px-4 py-2 text-sm">
                                                    <span className="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">{entry.category}</span>
                                                </td>
                                                <td className="px-4 py-2 text-sm text-gray-900">{entry.description}</td>
                                                <td className="px-4 py-2 text-sm font-medium text-gray-900">{parseFloat(entry.amount).toFixed(2)} QAR</td>
                                                <td className="px-4 py-2 text-sm text-gray-500">{entry.paid_by}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Inventory Overview */}
            <SectionLoadingPlaceholder isLoading={cardLoading.inventory}>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <InventoryOverview data={inventoryDataState} metrics={inventoryMetrics} />
                    <CategoryBreakdown data={inventoryDataState} />
                    <InventoryCharts data={inventoryDataState} />
                    <StockAlertsPanel alerts={inventoryAlerts} />
                </div>
            </SectionLoadingPlaceholder>
            {dashboardData && (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">üìà Performance Trends &amp; Insights</h3>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 className="font-medium text-gray-700 mb-3">Today's Performance Summary</h4>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center p-3 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg">
                                    <div>
                                        <p className="font-medium text-blue-800">Revenue Performance</p>
                                        <p className="text-sm text-blue-600">{calculateRevenuePerformance(dashboardData)}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-xl font-bold text-blue-600">{dashboardData.sales ? `${dashboardData.sales.total_revenue.toFixed(0)} QAR` : 'N/A'}</p>
                                        <p className="text-xs text-blue-500">{getPerformanceIndicator(dashboardData, 'revenue')}</p>
                                    </div>
                                </div>

                                <div className="flex justify-between items-center p-3 bg-gradient-to-r from-green-50 to-green-100 rounded-lg">
                                    <div>
                                        <p className="font-medium text-green-800">Cost Control</p>
                                        <p className="text-sm text-green-600">{calculateCostPerformance(dashboardData)}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-xl font-bold text-green-600">{dashboardData.sales ? `${dashboardData.sales.food_cost_percentage.toFixed(1)}%` : 'N/A'}</p>
                                        <p className="text-xs text-green-500">{getPerformanceIndicator(dashboardData, 'cost')}</p>
                                    </div>
                                </div>

                                <div className="flex justify-between items-center p-3 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg">
                                    <div>
                                        <p className="font-medium text-purple-800">Operational Efficiency</p>
                                        <p className="text-sm text-purple-600">{calculateOperationalEfficiency(dashboardData)}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-xl font-bold text-purple-600">{dashboardData.shawarma ? `${(100 - dashboardData.shawarma.waste_percentage).toFixed(1)}%` : 'N/A'}</p>
                                        <p className="text-xs text-purple-500">{getPerformanceIndicator(dashboardData, 'efficiency')}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 className="font-medium text-gray-700 mb-3">Key Metrics at a Glance</h4>
                            <div className="space-y-2">
                                {createMetricRow('Shawarma Profit/kg', dashboardData.shawarma ? `${dashboardData.shawarma.profit_per_kg.toFixed(2)} QAR` : 'N/A', dashboardData.shawarma ? (dashboardData.shawarma.profit_per_kg >= 10 ? 'excellent' : dashboardData.shawarma.profit_per_kg >= 7 ? 'good' : 'needs_improvement') : 'unknown')}
                                {createMetricRow('Revenue Quality Score', dashboardData.enhanced_analytics && dashboardData.enhanced_analytics.sales ? `${dashboardData.enhanced_analytics.sales.performance_metrics.revenue_quality_score.toFixed(0)}/100` : 'N/A', dashboardData.enhanced_analytics && dashboardData.enhanced_analytics.sales ? (dashboardData.enhanced_analytics.sales.performance_metrics.revenue_quality_score >= 80 ? 'excellent' : dashboardData.enhanced_analytics.sales.performance_metrics.revenue_quality_score >= 60 ? 'good' : 'needs_improvement') : 'unknown')}
                                {createMetricRow('Inventory Health', dashboardData.processed_analytics && dashboardData.processed_analytics.inventory_summary ? `${dashboardData.processed_analytics.inventory_summary.total_items - dashboardData.processed_analytics.inventory_summary.zero_stock - dashboardData.processed_analytics.inventory_summary.low_stock}/${dashboardData.processed_analytics.inventory_summary.total_items} OK` : 'N/A', dashboardData.processed_analytics && dashboardData.processed_analytics.inventory_summary ? (dashboardData.processed_analytics.inventory_summary.zero_stock === 0 && dashboardData.processed_analytics.inventory_summary.low_stock <= 2 ? 'excellent' : dashboardData.processed_analytics.inventory_summary.zero_stock === 0 && dashboardData.processed_analytics.inventory_summary.low_stock <= 5 ? 'good' : 'needs_improvement') : 'unknown')}
                                {createMetricRow('Petty Cash Control', dashboardData.enhanced_analytics && dashboardData.enhanced_analytics.pettyCash ? `${dashboardData.enhanced_analytics.pettyCash.total_amount.toFixed(2)} QAR` : '0.00 QAR', dashboardData.enhanced_analytics && dashboardData.enhanced_analytics.pettyCash ? (dashboardData.enhanced_analytics.pettyCash.total_amount <= 75 ? 'excellent' : dashboardData.enhanced_analytics.pettyCash.total_amount <= 150 ? 'good' : 'needs_improvement') : 'excellent')}
                                {createMetricRow('Payment Accuracy', dashboardData.enhanced_analytics && dashboardData.enhanced_analytics.sales ? `${dashboardData.enhanced_analytics.sales.payment_breakdown.variance_from_total.toFixed(2)} QAR diff` : 'N/A', dashboardData.enhanced_analytics && dashboardData.enhanced_analytics.sales ? (dashboardData.enhanced_analytics.sales.payment_breakdown.variance_from_total <= 2 ? 'excellent' : dashboardData.enhanced_analytics.sales.payment_breakdown.variance_from_total <= 10 ? 'good' : 'needs_improvement') : 'unknown')}
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Product Sales Breakdown */}
            {dashboardData && dashboardData.productSales && dashboardData.productSales.length > 0 && (
                <div className="bg-white rounded-lg shadow p-6">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">üìã Product Sales Breakdown</h3>
                    <div className="overflow-x-auto">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty Sold</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Food Cost</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profit Margin</th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {dashboardData.productSales.map((product, index) => (
                                    <tr key={index}>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                            {product.product_name}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {product.quantity_sold}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {product.total_revenue ? product.total_revenue.toFixed(2) : '0.00'} QAR
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {product.total_cost ? product.total_cost.toFixed(2) : '0.00'} QAR
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                                                (product.profit_margin || 0) > 75 ? 'bg-green-100 text-green-800' :
                                                (product.profit_margin || 0) > 60 ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-red-100 text-red-800'
                                            }`}>
                                                {product.profit_margin ? product.profit_margin.toFixed(1) : '0.0'}%
                                            </span>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            )}

            {/* Recommendations Engine */}
            {dashboardData && dashboardData.processed_analytics && (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <h3 className="text-lg font-semibold text-gray-800 mb-4">üéØ Smart Recommendations</h3>
                    <div className="space-y-4">
                        {generateSmartRecommendations(dashboardData).map((recommendation, index) => (
                            <div key={index} className={`border-l-4 p-4 rounded-lg ${recommendation.priority === 'high' ? 'border-red-500 bg-red-50' : recommendation.priority === 'medium' ? 'border-yellow-500 bg-yellow-50' : 'border-blue-500 bg-blue-50'}`}>
                                <div className="flex items-start gap-3">
                                    <span className="text-2xl">{recommendation.icon}</span>
                                    <div className="flex-1">
                                        <h4 className={`font-semibold ${recommendation.priority === 'high' ? 'text-red-800' : recommendation.priority === 'medium' ? 'text-yellow-800' : 'text-blue-800'}`}>{recommendation.title}</h4>
                                        <p className={`text-sm mt-1 ${recommendation.priority === 'high' ? 'text-red-700' : recommendation.priority === 'medium' ? 'text-yellow-700' : 'text-blue-700'}`}>{recommendation.description}</p>
                                        <div className="mt-2 flex items-center gap-2">
                                            <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${recommendation.priority === 'high' ? 'bg-red-100 text-red-800' : recommendation.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'}`}>{recommendation.category}</span>
                                            {recommendation.impact && <span className="text-xs text-gray-600">Impact: {recommendation.impact}</span>}
                                        </div>
                                        {recommendation.action && (
                                            <div className="mt-2">
                                                <p className="text-xs font-medium text-gray-800">Action: {recommendation.action}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            {/* Data Status Section - Collapsible */}
            <div className="bg-white rounded-lg shadow">
                <button
                    onClick={() => setShowDataStatus(!showDataStatus)}
                    className="w-full p-6 text-left flex justify-between items-center hover:bg-gray-50"
                >
                    <div>
                        <h3 className="text-lg font-semibold text-gray-800">üìä Data Status & Information</h3>
                        <p className="text-sm text-gray-600">View data availability and system information</p>
                    </div>
                    <div className={`transform transition-transform ${showDataStatus ? 'rotate-180' : ''}`}>
                        <svg className="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </button>
                
                {showDataStatus && (
                    <div className="px-6 pb-6 border-t">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            {/* Data Availability */}
                            <div>
                                <h4 className="font-medium text-gray-700 mb-3">Data Availability</h4>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Shawarma Data:</span>
                                        <span className={`font-medium ${dashboardData && dashboardData.data_found && dashboardData.data_found.shawarma ? 'text-green-600' : 'text-red-600'}`}>
                                            {dashboardData && dashboardData.data_found && dashboardData.data_found.shawarma ? 'Available' : 'Missing'}
                                        </span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Sales Data:</span>
                                        <span className={`font-medium ${dashboardData && dashboardData.data_found && dashboardData.data_found.sales ? 'text-green-600' : 'text-red-600'}`}>
                                            {dashboardData && dashboardData.data_found && dashboardData.data_found.sales ? 'Available' : 'Missing'}
                                        </span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Inventory Data:</span>
                                        <span className={`font-medium ${dashboardData && dashboardData.data_found && dashboardData.data_found.rawProteins ? 'text-green-600' : 'text-red-600'}`}>
                                            {dashboardData && dashboardData.data_found && dashboardData.data_found.rawProteins ? 'Available' : 'Missing'}
                                        </span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Bread Data:</span>
                                        <span className={`font-medium ${dashboardData && dashboardData.data_found && dashboardData.data_found.bread ? 'text-green-600' : 'text-red-600'}`}>
                                            {dashboardData && dashboardData.data_found && dashboardData.data_found.bread ? 'Available' : 'Missing'}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {/* Period Information */}
                            <div>
                                <h4 className="font-medium text-gray-700 mb-3">Period Information</h4>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Selected Period:</span>
                                        <span className="font-medium">{selectedPeriod === 'custom' ? 'Custom Date' : selectedPeriod.charAt(0).toUpperCase() + selectedPeriod.slice(1)}</span>
                                    </div>
                                    {customDate && (
                                        <div className="flex justify-between">
                                            <span className="text-gray-600">Custom Date:</span>
                                            <span className="font-medium">{customDate}</span>
                                        </div>
                                    )}
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Requested Date:</span>
                                        <span className="font-medium">{dashboardData && dashboardData.requested_date ? dashboardData.requested_date : 'N/A'}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Data Date:</span>
                                        <span className="font-medium">{dashboardData && dashboardData.date ? dashboardData.date : 'N/A'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Debug Data Toggle */}
                        <div className="mt-6 border-t pt-4">
                            <button
                                onClick={() => setShowDebugData(!showDebugData)}
                                className="flex items-center gap-2 text-sm text-gray-600 hover:text-gray-800"
                            >
                                <span className={`transform transition-transform ${showDebugData ? 'rotate-90' : ''}`}>
                                    ‚ñ∂
                                </span>
                                View Debug Data (Raw JSON)
                            </button>
                            
                            {showDebugData && (
                                <div className="mt-3">
                                    <div className="bg-gray-100 p-4 rounded-lg overflow-auto max-h-96">
                                        <pre className="text-xs text-gray-800">
                                            {JSON.stringify(dashboardData, null, 2)}
                                        </pre>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}

const InventoryOverview = ({ data, metrics }) => {
    if (!data || !metrics) return <div>Loading...</div>;
    return (
        <div className="space-y-6">
            <div className="mb-4 text-sm text-gray-600">Data Source: {data.dataSource === 'new_tables' ? 'New Tables' : 'Old Tables'}</div>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-blue-50 p-4 rounded text-center">
                    <h4 className="font-medium text-blue-800 text-sm">Total Items</h4>
                    <p className="text-xl font-bold text-blue-600">{data.summary.totalItems}</p>
                </div>
                <div className="bg-red-50 p-4 rounded text-center">
                    <h4 className="font-medium text-red-800 text-sm">Out of Stock</h4>
                    <p className="text-xl font-bold text-red-600">{data.summary.zeroStock}</p>
                </div>
                <div className="bg-yellow-50 p-4 rounded text-center">
                    <h4 className="font-medium text-yellow-800 text-sm">Low Stock</h4>
                    <p className="text-xl font-bold text-yellow-600">{data.summary.lowStock}</p>
                </div>
                <div className="bg-green-50 p-4 rounded text-center">
                    <h4 className="font-medium text-green-800 text-sm">Last Updated</h4>
                    <p className="text-md font-bold text-green-600">{data.summary.lastUpdated || 'N/A'}</p>
                </div>
            </div>
        </div>
    );
};

const CategoryBreakdown = ({ data }) => {
    if (!data) return null;
    return (
        <div className="mt-6">
            {Object.keys(data.categories).map(function(cat) {
                return (
                    <div key={cat} className="mb-4">
                        <h4 className="font-medium text-gray-700 mb-2">{cat}</h4>
                        <div className="space-y-1 text-sm">
                            {data.categories[cat].map(function(item) {
                                var status = item.quantity <= 0 ? 'text-red-600' : (item.min !== undefined && item.quantity <= parseFloat(item.min)) ? 'text-yellow-600' : 'text-green-600';
                                return (
                                    <div className="flex justify-between p-2 border rounded" key={item.name}>
                                        <span className="text-gray-600">{item.name}</span>
                                        <span className={"font-medium " + status}>{item.quantity} {item.unit}</span>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            })}
        </div>
    );
};

const InventoryCharts = ({ data }) => {
    return (
        <div className="mt-6">
            <p className="text-sm text-gray-600">Charts will display here.</p>
        </div>
    );
};

const StockAlertsPanel = ({ alerts }) => {
    if (!alerts || alerts.length === 0) return null;
    return (
        <div className="mt-6">
            <h4 className="font-medium text-gray-700 mb-2">Stock Alerts</h4>
            <div className="space-y-2">
                {alerts.map(function(a, i) {
                    return (
                        <div key={i} className="p-2 border-l-4 border-red-500 bg-red-50 text-sm">
                            <span className="font-medium">{a.item}:</span> {a.message}
                        </div>
                    );
                })}
            </div>
        </div>
    );
};

window.ManagementDashboard = ManagementDashboard;
</script>