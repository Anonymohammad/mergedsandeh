
<script type="text/babel">
const normalizeNumberInput = (value) => value.replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));

function getCurrentEmployeeSession() {
    // Allow management to override the active employee
    if (window.overrideEmployeeSession) {
        window.currentEmployeeSession = window.overrideEmployeeSession;
        return window.currentEmployeeSession;
    }

    let session = null;

    // Try to retrieve an authenticated session via helper (login token / PIN lookup)
    if (typeof window.getEmployeeSession === 'function') {
        session = window.getEmployeeSession();
    } else {
        const cookies = document.cookie.split(';').reduce((acc, cookie) => {
            const [key, value] = cookie.trim().split('=');
            if (key) acc[key] = value;
            return acc;
        }, {});
        if (cookies.employeeId && cookies.sessionExpiry && new Date(cookies.sessionExpiry) > new Date()) {
            session = {
                employeeId: cookies.employeeId,
                employeeName: cookies.employeeName,
                employeeRole: cookies.employeeRole
            };
        }
    }

    if (session) {
        window.currentEmployeeSession = {
            employee_id: session.employeeId,
            employee_name: session.employeeName || 'Management',
            role: session.employeeRole || 'employee'
        };
    } else {
        // Default to management when no authenticated employee exists
        window.currentEmployeeSession = { employee_id: 'management', employee_name: 'Management', role: 'management' };
    }

    return window.currentEmployeeSession;
}

function initializeEmployeeContext() {
    const session = getCurrentEmployeeSession();
    if (session && session.employee_id && session.employee_id !== 'management') {
        window.currentEmployeeSession = session;
    } else {
        window.currentEmployeeSession = { employee_id: 'management', employee_name: 'Management', role: 'management' };
    }
}

function EmployeeContextDisplay({ employee, t }) {
    return React.createElement('div', { className: 'text-sm text-gray-600 mb-4' },
        `${t('entryBy')}: ${employee.employee_name} (${employee.role})`
    );
}

function convertInventoryDataToNestedFormat(inventory) {
    const nested = {
        rawProteins: {},
        marinatedProteins: {},
        bread: {},
        highCostItems: {}
    };

    const keyMappings = {
        'chicken_breast_opening': 'rawProteins.frozen_chicken_breast_opening',
        'chicken_breast_received': 'rawProteins.frozen_chicken_breast_received',
        'chicken_breast_expired': 'rawProteins.frozen_chicken_breast_expired',
        'chicken_breast_remaining': 'rawProteins.frozen_chicken_breast_remaining',
        'chicken_shawarma_opening': 'rawProteins.chicken_shawarma_opening',
        'chicken_shawarma_received': 'rawProteins.chicken_shawarma_received',
        'chicken_shawarma_expired': 'rawProteins.chicken_shawarma_expired',
        'chicken_shawarma_remaining': 'rawProteins.chicken_shawarma_remaining',
        'steak_opening': 'rawProteins.steak_opening',
        'steak_received': 'rawProteins.steak_received',
        'steak_expired': 'rawProteins.steak_expired',
        'steak_remaining': 'rawProteins.steak_remaining',
        'fahita_chicken_opening': 'marinatedProteins.fahita_chicken_opening',
        'fahita_chicken_received': 'marinatedProteins.fahita_chicken_received',
        'fahita_chicken_expired': 'marinatedProteins.fahita_chicken_expired',
        'fahita_chicken_remaining': 'marinatedProteins.fahita_chicken_remaining',
        'chicken_sub_opening': 'marinatedProteins.chicken_sub_opening',
        'chicken_sub_received': 'marinatedProteins.chicken_sub_received',
        'chicken_sub_expired': 'marinatedProteins.chicken_sub_expired',
        'chicken_sub_remaining': 'marinatedProteins.chicken_sub_remaining',
        'spicy_strips_opening': 'marinatedProteins.spicy_strips_opening',
        'spicy_strips_received': 'marinatedProteins.spicy_strips_received',
        'spicy_strips_expired': 'marinatedProteins.spicy_strips_expired',
        'spicy_strips_remaining': 'marinatedProteins.spicy_strips_remaining',
        'original_strips_opening': 'marinatedProteins.original_strips_opening',
        'original_strips_received': 'marinatedProteins.original_strips_received',
        'original_strips_expired': 'marinatedProteins.original_strips_expired',
        'original_strips_remaining': 'marinatedProteins.original_strips_remaining',
        'marinated_steak_opening': 'marinatedProteins.marinated_steak_opening',
        'marinated_steak_received': 'marinatedProteins.marinated_steak_received',
        'marinated_steak_expired': 'marinatedProteins.marinated_steak_expired',
        'marinated_steak_remaining': 'marinatedProteins.marinated_steak_remaining',
        'saj_bread_opening': 'bread.saj_bread_opening',
        'saj_bread_received': 'bread.saj_bread_received',
        'saj_bread_expired': 'bread.saj_bread_expired',
        'saj_bread_remaining': 'bread.saj_bread_remaining',
        'pita_bread_opening': 'bread.pita_bread_opening',
        'pita_bread_received': 'bread.pita_bread_received',
        'pita_bread_expired': 'bread.pita_bread_expired',
        'pita_bread_remaining': 'bread.pita_bread_remaining',
        'bread_rolls_opening': 'bread.bread_rolls_opening',
        'bread_rolls_received': 'bread.bread_rolls_received',
        'bread_rolls_expired': 'bread.bread_rolls_expired',
        'bread_rolls_remaining': 'bread.bread_rolls_remaining',
        'cream_opening': 'highCostItems.cream_opening',
        'cream_received': 'highCostItems.cream_received',
        'cream_expired': 'highCostItems.cream_expired',
        'cream_remaining': 'highCostItems.cream_remaining',
        'mayo_opening': 'highCostItems.mayo_opening',
        'mayo_received': 'highCostItems.mayo_received',
        'mayo_expired': 'highCostItems.mayo_expired',
        'mayo_remaining': 'highCostItems.mayo_remaining'
    };

    Object.keys(inventory || {}).forEach(key => {
        const mapping = keyMappings[key];
        if (mapping) {
            const [section, field] = mapping.split('.');
            if (!nested[section]) nested[section] = {};
            nested[section][field] = inventory[key];
        }
    });

    return nested;
}


function PettyCashEntryForm({ entry, onChange, onSubmit, onCancel, isEditing, categories, t }) {
    return React.createElement('div', { className: 'space-y-2 petty-cash-form' },
        React.createElement('select', {
            value: entry.category,
            onChange: e => onChange({ ...entry, category: e.target.value }),
            className: 'w-full p-2 border rounded'
        }, [
            React.createElement('option', { key: '', value: '' }, t('selectCategory')),
            ...categories.map(cat => React.createElement('option', { key: cat.key, value: cat.key }, cat.label))
        ]),
        React.createElement('input', {
            type: 'text',
            value: entry.description,
            onChange: e => onChange({ ...entry, description: e.target.value }),
            className: 'w-full p-2 border rounded',
            placeholder: t('description'),
            required: true
        }),
        React.createElement('input', {
            type: 'number',
            step: '0.01',
            min: '0.01',
            value: entry.amount,
            onChange: e => onChange({ ...entry, amount: normalizeNumberInput(e.target.value) }),
            className: 'w-full p-2 border rounded',
            placeholder: t('amount'),
            required: true
        }),
        React.createElement('input', {
            type: 'text',
            value: entry.paid_by,
            onChange: e => onChange({ ...entry, paid_by: e.target.value }),
            className: 'w-full p-2 border rounded',
            placeholder: t('paidBy'),
            required: true
        }),
        React.createElement('div', { className: 'flex space-x-2 modal-actions' },
            React.createElement('button', {
                type: 'button',
                onClick: onSubmit,
                className: 'bg-olive-600 text-white px-4 py-2 rounded'
            }, isEditing ? t('updateEntry') : t('addEntry')),
            isEditing && React.createElement('button', {
                type: 'button',
                onClick: onCancel,
                className: 'bg-gray-500 text-white px-4 py-2 rounded'
            }, t('cancelEdit'))
        )
    );
}

function PettyCashEntriesList({ entries, onEdit, onDelete, categories, t }) {
    const total = entries.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);

    const getCategoryLabel = (key) => {
        const cat = categories.find(c => c.key === key);
        return cat ? cat.label : key;
    };

    if (entries.length === 0) {
        return React.createElement('p', { className: 'mt-4 text-sm text-gray-500' }, t('noPettyCashEntries'));
    }

    return React.createElement('div', { className: 'mt-4 petty-cash-table' },
        React.createElement('table', { className: 'min-w-full text-sm border' },
            React.createElement('thead', null,
                React.createElement('tr', { className: 'bg-gray-100' },
                    [t('category'), t('description'), t('amount'), t('paidBy'), t('actions')].map((h, i) =>
                        React.createElement('th', { key: i, className: 'px-2 py-1 border text-start' }, h)
                    )
                )
            ),
            React.createElement('tbody', null,
                entries.map((e, idx) =>
                    React.createElement('tr', { key: idx },
                        React.createElement('td', { className: 'border px-2 py-1' }, getCategoryLabel(e.category)),
                        React.createElement('td', { className: 'border px-2 py-1' }, e.description),
                        React.createElement('td', { className: 'border px-2 py-1' }, parseFloat(e.amount).toFixed(2)),
                        React.createElement('td', { className: 'border px-2 py-1' }, e.paid_by),
                        React.createElement('td', { className: 'border px-2 py-1 space-x-2' },
                            React.createElement('button', { type: 'button', onClick: () => onEdit(idx), className: 'text-blue-600' }, t('editEntry')),
                            React.createElement('button', { type: 'button', onClick: () => onDelete(idx), className: 'text-red-600' }, t('deleteEntry'))
                        )
                    )
                ),
                React.createElement('tr', { className: 'font-medium bg-gray-50' },
                    React.createElement('td', { className: 'border px-2 py-1', colSpan: 2 }, t('totalAmount')),
                    React.createElement('td', { className: 'border px-2 py-1' }, total.toFixed(2)),
                    React.createElement('td', { className: 'border px-2 py-1', colSpan: 2 }, '')
                )
            )
        )
    );
}

function PettyCashModal({ open, onClose, entries, entry, setEntry, editingIndex, onAdd, onUpdate, onEdit, onDelete, onCancel, categories, t }) {
    React.useEffect(() => {
        const handler = e => {
            if (e.key === 'Escape') onClose();
        };
        if (open) document.addEventListener('keydown', handler);
        return () => document.removeEventListener('keydown', handler);
    }, [open]);

    if (!open) return null;

    return React.createElement('div', {
        className: 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50',
        onClick: e => { if (e.target === e.currentTarget) onClose(); }
    },
        React.createElement('div', { className: 'bg-white p-6 rounded w-full max-w-2xl petty-cash-modal' },
            React.createElement('h3', { className: 'text-lg font-semibold mb-4' }, t('managePettyCashEntries')),
            React.createElement(PettyCashEntryForm, {
                entry: entry,
                onChange: setEntry,
                onSubmit: editingIndex >= 0 ? onUpdate : onAdd,
                onCancel: onCancel,
                isEditing: editingIndex >= 0,
                categories: categories,
                t: t
            }),
            React.createElement(PettyCashEntriesList, { entries: entries, onEdit: onEdit, onDelete: onDelete, categories: categories, t: t }),
            React.createElement('div', { className: 'mt-4 text-right modal-actions' },
                React.createElement('button', {
                    type: 'button',
                    onClick: onClose,
                    className: 'bg-gray-500 text-white px-4 py-2 rounded'
                }, t('close'))
            )
        )
    );
}

function DailyEntryTab() {
    const { t } = React.useContext(window.LanguageContext);
    const { state, setState } = React.useContext(window.AppContext);
    const [pinError, setPinError] = React.useState(false);
    const [pinAttempted, setPinAttempted] = React.useState(false);
    const [employeeContext, setEmployeeContext] = React.useState(getCurrentEmployeeSession());

    React.useEffect(() => {
        initializeEmployeeContext();
        setEmployeeContext(getCurrentEmployeeSession());
    }, [state && state.employeeSession]);
    const [formData, setFormData] = React.useState({
        // Shawarma Stack Data (No carry forward - fresh daily, NO revenue field)
        shawarmaStack: {
            starting_weight: '',
            remaining_weight: '',
            shaving_weight: '',
            staff_meals_weight: '',
            orders_weight: ''
        },
        
        // Raw Proteins (Carry forward from previous day)
        rawProteins: {
            // Frozen Chicken Breast
            frozen_chicken_breast_opening: '',
            frozen_chicken_breast_received: '',
            frozen_chicken_breast_expired: '',
            frozen_chicken_breast_remaining: '',
            
            // Chicken Shawarma
            chicken_shawarma_opening: '',
            chicken_shawarma_received: '',
            chicken_shawarma_expired: '',
            chicken_shawarma_remaining: '',
            
            // Steak
            steak_opening: '',
            steak_received: '',
            steak_expired: '',
            steak_remaining: ''
        },
        
        // Marinated Ready-to-Use (Carry forward from previous day)
        marinatedProteins: {
            // Fahita Chicken
            fahita_chicken_opening: '',
            fahita_chicken_received: '',
            fahita_chicken_expired: '',
            fahita_chicken_remaining: '',
            
            // Chicken Sub
            chicken_sub_opening: '',
            chicken_sub_received: '',
            chicken_sub_expired: '',
            chicken_sub_remaining: '',
            
            // Spicy Strips
            spicy_strips_opening: '',
            spicy_strips_received: '',
            spicy_strips_expired: '',
            spicy_strips_remaining: '',
            
            // Original Strips
            original_strips_opening: '',
            original_strips_received: '',
            original_strips_expired: '',
        original_strips_remaining: '',
    
    // ADD THIS NEW SECTION:
    // Marinated Steak
    marinated_steak_opening: '',
    marinated_steak_received: '',
    marinated_steak_expired: '',
    marinated_steak_remaining: ''
        },
        
        // Daily Bread Tracking (Carry forward from previous day)
        bread: {
            // Saj Bread
            saj_bread_opening: '',
            saj_bread_received: '',
            saj_bread_expired: '',
            saj_bread_remaining: '',
            
            // Pita Bread
            pita_bread_opening: '',
            pita_bread_received: '',
            pita_bread_expired: '',
            pita_bread_remaining: '',
            
            // Bread Rolls
            bread_rolls_opening: '',
            bread_rolls_received: '',
            bread_rolls_expired: '',
            bread_rolls_remaining: ''
        },
        
        // High-Cost Items (Carry forward from previous day)
        highCostItems: {
            // Cream
            cream_opening: '',
            cream_received: '',
            cream_expired: '',
            cream_remaining: '',
            
            // Mayo
            mayo_opening: '',
            mayo_received: '',
            mayo_expired: '',
            mayo_remaining: ''
        },
        
        // Daily Sales
        sales: {
            total_revenue: '',
            shawarma_revenue: '',
            cash_sales: '',
            card_sales: '',
            delivery_aggregator_1: '',
            delivery_aggregator_2: '',
            other_food_revenue: '',
            petty_cash_total: ''
        },
        
        // Notes
        notes: ''
    });
    
    const [loading, setLoading] = React.useState(false);
    const [calculatedMetrics, setCalculatedMetrics] = React.useState(null);
    const [selectedDate, setSelectedDate] = React.useState(new Date().toISOString().split('T')[0]);
    const [existingEntry, setExistingEntry] = React.useState(null);
    const [managementPin, setManagementPin] = React.useState('');
    const [showPinInput, setShowPinInput] = React.useState(false);
    const [duplicateWarning, setDuplicateWarning] = React.useState(false);
    const [isUpdateMode, setIsUpdateMode] = React.useState(false);
    const [loadingExistingData, setLoadingExistingData] = React.useState(false);
    const [checkingExistingData, setCheckingExistingData] = React.useState(false);
    const [fieldsLocked, setFieldsLocked] = React.useState(false);
    const [showLoadExistingPin, setShowLoadExistingPin] = React.useState(false);
    const [loadExistingPin, setLoadExistingPin] = React.useState('');

    // Petty cash state
    const [pettyCashEntries, setPettyCashEntries] = React.useState([]);
    const [showPettyCashModal, setShowPettyCashModal] = React.useState(false);
    const [currentPettyCashEntry, setCurrentPettyCashEntry] = React.useState({
        id: null,
        category: '',
        description: '',
        amount: '',
        paid_by: ''
    });
    const [editingEntryIndex, setEditingEntryIndex] = React.useState(-1);

    const validateTranslations = () => {
        const requiredKeys = [
            'pettyCash', 'addPettyCashEntry', 'category', 'description', 'amount', 'paidBy',
            'cashSales', 'cardSales', 'deliveryAggregator1', 'deliveryAggregator2', 'otherFoodRevenue',
            'pettyCashTotal', 'selectCategory', 'fieldRequired', 'amountMustBePositive', 'confirmDeleteEntry'
        ];
        requiredKeys.forEach(key => {
            if (!t(key) || t(key) === key) {
                console.warn(`Missing translation for key: ${key}`);
            }
        });
    };

    React.useEffect(() => {
        validateTranslations();
    }, []);

    const INVENTORY_CONFIG = {
        rawProteins: {
            titleKey: 'Frozen Raw Proteins',
            items: [
                { key: 'frozen_chicken_breast', label: 'Frozen Chicken Breast', item_id: null },
                { key: 'chicken_shawarma', label: 'Chicken Shawarma', item_id: null },
                { key: 'steak', label: 'Steak', item_id: null }
            ]
        },
        marinatedProteins: {
            titleKey: 'Marinated Proteins',
            items: [
                { key: 'fahita_chicken', label: 'Fahita Chicken', item_id: null },
                { key: 'chicken_sub', label: 'Chicken Sub', item_id: null },
                { key: 'spicy_strips', label: 'Spicy Strips', item_id: null },
                { key: 'original_strips', label: 'Original Strips', item_id: null },
                { key: 'marinated_steak', label: 'Marinated Steak', item_id: null }
            ]
        },
        bread: {
            titleKey: 'Bread Items',
            items: [
                { key: 'saj_bread', label: 'Saj Bread (0.9 QAR each)', item_id: null },
                { key: 'pita_bread', label: 'Pita Bread (0.1 QAR each)', item_id: null },
                { key: 'bread_rolls', label: 'Bread Rolls (0.5 QAR each)', item_id: null }
            ]
        },
        highCostItems: {
            titleKey: 'High-Cost Items',
            items: [
                { key: 'cream', label: 'Cream (20 QAR/kg)', item_id: null },
                { key: 'mayo', label: 'Mayo (17.5 QAR/kg)', item_id: null }
            ]
        }
    };

    const PETTY_CASH_CATEGORIES = [
        { key: 'fuel', label: 'Fuel' },
        { key: 'ingredients', label: 'Ingredients' },
        { key: 'supplies', label: 'Supplies' },
        { key: 'equipment', label: 'Equipment' },
        { key: 'utilities', label: 'Utilities' },
        { key: 'maintenance', label: 'Maintenance' },
        { key: 'transportation', label: 'Transportation' },
        { key: 'other', label: 'Other' }
    ];

    // NEW: Dynamic range calculation functions
    const getAcceptableRemainingRange = (stackWeightKg) => {
        return {
            min: 0.6,    // 600g minimum
            max: 0.85,   // 850g maximum  
            optimal: Math.min(0.8, stackWeightKg * 0.06) // 6% or 800g, whichever smaller
        };
    };

    const getAcceptableLossRange = () => {
        return {
            min: 12,  // 12% minimum loss
            max: 28   // 28% maximum loss
        };
    };

    const getAcceptableTotalWasteRange = (stackWeightKg) => {
        const lossRange = getAcceptableLossRange();
        const remainingRange = getAcceptableRemainingRange(stackWeightKg);
        
        const minTotalWaste = lossRange.min + (remainingRange.min / stackWeightKg * 100);
        const maxTotalWaste = lossRange.max + (remainingRange.max / stackWeightKg * 100);
        
        return {
            min: Math.round(minTotalWaste * 10) / 10,  // Round to 1 decimal
            max: Math.round(maxTotalWaste * 10) / 10
        };
    };
    
    // Calculate metrics in real-time
    React.useEffect(() => {
        calculateMetrics();
    }, [formData]);
    
    // Check for existing entry when date changes
    React.useEffect(() => {
        if (selectedDate) {
            checkExistingEntry();
        }
    }, [selectedDate]);
    
    // Load previous day data only after existing data check completes and no data found
    React.useEffect(() => {
        if (!checkingExistingData && !duplicateWarning && selectedDate === new Date().toISOString().split('T')[0]) {
            loadPreviousDayData();
        }
    }, [checkingExistingData, duplicateWarning, selectedDate]);

    const loadItemMappings = () => {
        try {
            google.script.run
                .withSuccessHandler(mappings => {
                    Object.values(INVENTORY_CONFIG).forEach(section => {
                        section.items.forEach(item => {
                            if (mappings[item.key]) {
                                item.item_id = mappings[item.key];
                            }
                        });
                    });
                })
                .withFailureHandler(err => console.error('Error loading item mappings', err))
                .getAllLegacyKeyMappings();
        } catch (err) {
            console.error('Error loading item mappings', err);
        }
    };

    React.useEffect(() => {
        loadItemMappings();
    }, []);
    
    const checkExistingEntry = async () => {
        setCheckingExistingData(true);
        setDuplicateWarning(false);
        setExistingEntry(null);
        setIsUpdateMode(false);
        setFieldsLocked(true);
        setShowPinInput(false);
        setShowLoadExistingPin(false);
        
        setPinError(false);
        setPinAttempted(false);
        setLoadExistingPin('');
        
        try {
            await google.script.run
                .withSuccessHandler(result => {
                    const data = JSON.parse(result);
                    setCheckingExistingData(false);
                    
                    if (data.exists) {
                        setExistingEntry(data.entry);
                        setDuplicateWarning(true);
                        setFieldsLocked(true);
                        setShowLoadExistingPin(true);
                    } else {
                        resetFormToClean();
                    }
                })
                .withFailureHandler(error => {
                    console.error('Error checking existing entry:', error);
                    setCheckingExistingData(false);
                    resetFormToClean();
                })
                .checkExistingEntry(selectedDate);
        } catch (error) {
            console.error('Error checking existing entry:', error);
            setCheckingExistingData(false);
            resetFormToClean();
        }
    };
    
    const loadPreviousDayData = async () => {
        if (selectedDate === new Date().toISOString().split('T')[0] && !duplicateWarning) {
            console.log('Loading previous day data for today...');
            
            try {
                const previousDate = new Date(selectedDate);
                previousDate.setDate(previousDate.getDate() - 1);
                const prevDateString = previousDate.toISOString().split('T')[0];
                
                await google.script.run
                    .withSuccessHandler(result => {
                        const data = JSON.parse(result);
                        if (data && data.inventory) {
                            setFormData(prev => ({
                                ...prev,
                                rawProteins: {
                                    ...prev.rawProteins,
                                    frozen_chicken_breast_opening: data.inventory.frozen_chicken_breast_remaining || '',
                                    chicken_shawarma_opening: data.inventory.chicken_shawarma_remaining || '',
                                    steak_opening: data.inventory.steak_remaining || ''
                                },
                                marinatedProteins: {
                                    ...prev.marinatedProteins,
                                    fahita_chicken_opening: data.inventory.fahita_chicken_remaining || '',
                                    chicken_sub_opening: data.inventory.chicken_sub_remaining || '',
                                    spicy_strips_opening: data.inventory.spicy_strips_remaining || '',
                                    original_strips_opening: data.inventory.original_strips_remaining || '',
                                     marinated_steak_opening: data.inventory.marinated_steak_remaining || ''
                                },
                                bread: {
                                    ...prev.bread,
                                    saj_bread_opening: data.inventory.saj_bread_remaining || '',
                                    pita_bread_opening: data.inventory.pita_bread_remaining || '',
                                    bread_rolls_opening: data.inventory.bread_rolls_remaining || ''
                                },
                                highCostItems: {
                                    ...prev.highCostItems,
                                    cream_opening: data.inventory.cream_remaining || '',
                                    mayo_opening: data.inventory.mayo_remaining || ''
                                }
                            }));
                        }
                    })
                    .withFailureHandler(error => {
                        console.error('Error loading previous day data:', error);
                    })
                    .generateDailyReport(prevDateString);
            } catch (error) {
                console.error('Error loading previous day data:', error);
            }
        }
    };
    
    // UPDATED: Enhanced calculation metrics with dynamic ranges
    const calculateMetrics = () => {
        const { shawarmaStack, sales } = formData;
        
        if (!shawarmaStack.starting_weight || !shawarmaStack.remaining_weight) {
            setCalculatedMetrics(null);
            return;
        }
        
        // Shawarma calculations
        const startingWeight = parseFloat(shawarmaStack.starting_weight) || 0;
        const remainingWeight = parseFloat(shawarmaStack.remaining_weight) || 0;
        const shavingWeight = parseFloat(shawarmaStack.shaving_weight) || 0;
        const staffMealsWeight = parseFloat(shawarmaStack.staff_meals_weight) || 0;
        const ordersWeight = parseFloat(shawarmaStack.orders_weight) || 0;
        
        // Calculate loss (natural cooking/heat shrinkage)
        const lossWeight = startingWeight - (ordersWeight + shavingWeight + staffMealsWeight + remainingWeight);
        const lossPercentage = startingWeight > 0 ? (lossWeight / startingWeight) * 100 : 0;
        
        // Calculate total waste (loss + remaining)
        const totalWasteWeight = lossWeight + remainingWeight;
        const totalWastePercentage = startingWeight > 0 ? (totalWasteWeight / startingWeight) * 100 : 0;
        
        // Calculate profitability (get revenue from sales section)
        const shawarmaRevenue = parseFloat(sales.shawarma_revenue) || 0;
        const revenuePerKg = ordersWeight > 0 ? shawarmaRevenue / ordersWeight : 0;
        
        // NEW: Get dynamic ranges
        const lossRange = getAcceptableLossRange();
        const remainingRange = getAcceptableRemainingRange(startingWeight);
        const totalWasteRange = getAcceptableTotalWasteRange(startingWeight);
        
        // NEW: Generate alerts based on dynamic ranges
        const alerts = [];
        
        // Loss percentage alerts (fixed range)
        if (lossPercentage > lossRange.max) {
            alerts.push({
                type: 'danger',
                message: `Cooking loss ${lossPercentage.toFixed(1)}% exceeds maximum ${lossRange.max}%`
            });
        } else if (lossPercentage > 25) {
            alerts.push({
                type: 'warning',
                message: `Cooking loss ${lossPercentage.toFixed(1)}% is above optimal (25%)`
            });
        }
        
        // Remaining weight alerts (dynamic range)
        if (remainingWeight > remainingRange.max) {
            alerts.push({
                type: 'danger',
                message: `Remaining ${(remainingWeight * 1000).toFixed(0)}g exceeds maximum ${(remainingRange.max * 1000).toFixed(0)}g`
            });
        } else if (remainingWeight > remainingRange.optimal) {
            alerts.push({
                type: 'warning',
                message: `Remaining ${(remainingWeight * 1000).toFixed(0)}g is above optimal ${(remainingRange.optimal * 1000).toFixed(0)}g`
            });
        }
        
        // Staff meals alert
        if (staffMealsWeight > 0.4) {
            alerts.push({
                type: 'warning',
                message: `Staff meals ${(staffMealsWeight * 1000).toFixed(0)}g exceeds limit (400g)`
            });
        }
        
        // Total waste alert (dynamic range)
        if (totalWastePercentage > totalWasteRange.max) {
            alerts.push({
                type: 'danger',
                message: `Total waste ${totalWastePercentage.toFixed(1)}% exceeds maximum ${totalWasteRange.max.toFixed(1)}%`
            });
        }
        
        // Sales calculations
        const totalRevenue = parseFloat(sales.total_revenue) || 0;
        
        setCalculatedMetrics({
            shawarma: {
                lossWeight: lossWeight.toFixed(3),
                lossPercentage: lossPercentage.toFixed(1),
                totalWasteWeight: totalWasteWeight.toFixed(3),
                totalWastePercentage: totalWastePercentage.toFixed(1),
                revenuePerKg: revenuePerKg.toFixed(2)
            },
            sales: {
                shawarmaPercentage: totalRevenue > 0 ? ((shawarmaRevenue / totalRevenue) * 100).toFixed(1) : '0.0'
            },
            ranges: {
                lossRange: lossRange,
                remainingRange: remainingRange,
                totalWasteRange: totalWasteRange
            },
            alerts: alerts,
            usage: calculateUsage()
        });
    };
    
    // Calculate usage for inventory items
    const calculateUsage = () => {
        const usageCalculations = {};
        
        // Raw Proteins Usage
        ['frozen_chicken_breast', 'chicken_shawarma', 'steak'].forEach(item => {
            const opening = parseFloat(formData.rawProteins[item + '_opening']) || 0;
            const received = parseFloat(formData.rawProteins[item + '_received']) || 0;
            const expired = parseFloat(formData.rawProteins[item + '_expired']) || 0;
            const remaining = parseFloat(formData.rawProteins[item + '_remaining']) || 0;
            const usage = opening + received - expired - remaining;
            usageCalculations['rawProteins_' + item + '_usage'] = usage.toFixed(3);
        });
        
        // Marinated Proteins Usage
        ['fahita_chicken', 'chicken_sub', 'spicy_strips', 'original_strips', 'marinated_steak'].forEach(item => {
            const opening = parseFloat(formData.marinatedProteins[item + '_opening']) || 0;
            const received = parseFloat(formData.marinatedProteins[item + '_received']) || 0;
            const expired = parseFloat(formData.marinatedProteins[item + '_expired']) || 0;
            const remaining = parseFloat(formData.marinatedProteins[item + '_remaining']) || 0;
            const usage = opening + received - expired - remaining;
            usageCalculations['marinatedProteins_' + item + '_usage'] = usage.toFixed(3);
        });
        
        // Bread Usage
        ['saj_bread', 'pita_bread', 'bread_rolls'].forEach(item => {
            const opening = parseFloat(formData.bread[item + '_opening']) || 0;
            const received = parseFloat(formData.bread[item + '_received']) || 0;
            const expired = parseFloat(formData.bread[item + '_expired']) || 0;
            const remaining = parseFloat(formData.bread[item + '_remaining']) || 0;
            const usage = opening + received - expired - remaining;
            usageCalculations['bread_' + item + '_usage'] = usage.toFixed(0);
        });
        
        // High-Cost Items Usage
        ['cream', 'mayo'].forEach(item => {
            const opening = parseFloat(formData.highCostItems[item + '_opening']) || 0;
            const received = parseFloat(formData.highCostItems[item + '_received']) || 0;
            const expired = parseFloat(formData.highCostItems[item + '_expired']) || 0;
            const remaining = parseFloat(formData.highCostItems[item + '_remaining']) || 0;
            const usage = opening + received - expired - remaining;
            usageCalculations['highCostItems_' + item + '_usage'] = usage.toFixed(3);
        });
        
        return usageCalculations;
    };
    
    const handleInputChange = (section, field, value) => {
        const normalized = normalizeNumberInput(value);
        setFormData(prev => ({
            ...prev,
            [section]: {
                ...prev[section],
                [field]: normalized
            }
        }));
    };
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        
        // Check if updating existing entry
        if (isUpdateMode && !showPinInput) {
            setShowPinInput(true);
            return;
        }

        // Validate PIN if updating
        if (isUpdateMode && showPinInput) {
            if (!managementPin || managementPin.trim() === '') {
                alert(t('enterManagementPin'));
                return;
            }
        }
        
        setLoading(true);
        
        try {
            // Prepare data for backend
            const inventory = {
                chicken_breast_opening: formData.rawProteins.frozen_chicken_breast_opening,
                chicken_breast_received: formData.rawProteins.frozen_chicken_breast_received,
                chicken_breast_expired: formData.rawProteins.frozen_chicken_breast_expired,
                chicken_breast_remaining: formData.rawProteins.frozen_chicken_breast_remaining,
                chicken_shawarma_opening: formData.rawProteins.chicken_shawarma_opening,
                chicken_shawarma_received: formData.rawProteins.chicken_shawarma_received,
                chicken_shawarma_expired: formData.rawProteins.chicken_shawarma_expired,
                chicken_shawarma_remaining: formData.rawProteins.chicken_shawarma_remaining,
                steak_opening: formData.rawProteins.steak_opening,
                steak_received: formData.rawProteins.steak_received,
                steak_expired: formData.rawProteins.steak_expired,
                steak_remaining: formData.rawProteins.steak_remaining,

                // Marinated proteins
                fahita_chicken_opening: formData.marinatedProteins.fahita_chicken_opening,
                fahita_chicken_received: formData.marinatedProteins.fahita_chicken_received,
                fahita_chicken_expired: formData.marinatedProteins.fahita_chicken_expired,
                fahita_chicken_remaining: formData.marinatedProteins.fahita_chicken_remaining,
                chicken_sub_opening: formData.marinatedProteins.chicken_sub_opening,
                chicken_sub_received: formData.marinatedProteins.chicken_sub_received,
                chicken_sub_expired: formData.marinatedProteins.chicken_sub_expired,
                chicken_sub_remaining: formData.marinatedProteins.chicken_sub_remaining,
                spicy_strips_opening: formData.marinatedProteins.spicy_strips_opening,
                spicy_strips_received: formData.marinatedProteins.spicy_strips_received,
                spicy_strips_expired: formData.marinatedProteins.spicy_strips_expired,
                spicy_strips_remaining: formData.marinatedProteins.spicy_strips_remaining,
                original_strips_opening: formData.marinatedProteins.original_strips_opening,
                original_strips_received: formData.marinatedProteins.original_strips_received,
                original_strips_expired: formData.marinatedProteins.original_strips_expired,
                original_strips_remaining: formData.marinatedProteins.original_strips_remaining,
                marinated_steak_opening: formData.marinatedProteins.marinated_steak_opening,
                marinated_steak_received: formData.marinatedProteins.marinated_steak_received,
                marinated_steak_expired: formData.marinatedProteins.marinated_steak_expired,
                marinated_steak_remaining: formData.marinatedProteins.marinated_steak_remaining,

                saj_bread_opening: formData.bread.saj_bread_opening,
                saj_bread_received: formData.bread.saj_bread_received,
                saj_bread_expired: formData.bread.saj_bread_expired,
                saj_bread_remaining: formData.bread.saj_bread_remaining,
                pita_bread_opening: formData.bread.pita_bread_opening,
                pita_bread_received: formData.bread.pita_bread_received,
                pita_bread_expired: formData.bread.pita_bread_expired,
                pita_bread_remaining: formData.bread.pita_bread_remaining,
                bread_rolls_opening: formData.bread.bread_rolls_opening,
                bread_rolls_received: formData.bread.bread_rolls_received,
                bread_rolls_expired: formData.bread.bread_rolls_expired,
                bread_rolls_remaining: formData.bread.bread_rolls_remaining,

                cream_opening: formData.highCostItems.cream_opening,
                cream_received: formData.highCostItems.cream_received,
                cream_expired: formData.highCostItems.cream_expired,
                cream_remaining: formData.highCostItems.cream_remaining,
                mayo_opening: formData.highCostItems.mayo_opening,
                mayo_received: formData.highCostItems.mayo_received,
                mayo_expired: formData.highCostItems.mayo_expired,
                mayo_remaining: formData.highCostItems.mayo_remaining
            };

            const entryData = {
                date: selectedDate,
                employeeId: getCurrentEmployeeSession().employee_id,
                employeeName: getCurrentEmployeeSession().employee_name,
                shawarmaStack: {
                    ...formData.shawarmaStack,
                    revenue: formData.sales.shawarma_revenue,
                    loss_weight: calculatedMetrics && calculatedMetrics.shawarma ? calculatedMetrics.shawarma.lossWeight : 0,
                    loss_percentage: calculatedMetrics && calculatedMetrics.shawarma ? calculatedMetrics.shawarma.lossPercentage : 0,
                    total_waste_weight: calculatedMetrics && calculatedMetrics.shawarma ? calculatedMetrics.shawarma.totalWasteWeight : 0,
                    total_waste_percentage: calculatedMetrics && calculatedMetrics.shawarma ? calculatedMetrics.shawarma.totalWastePercentage : 0
                },
                sales: {
                    ...formData.sales,
                    other_food_revenue: calculateOtherFoodRevenue(),
                    petty_cash_total: calculatePettyCashTotal()
                },
                pettyCashEntries: pettyCashEntries,
                inventory: inventory,
                notes: formData.notes,
                isUpdate: isUpdateMode,
                managementPin: isUpdateMode ? managementPin : null
            };
            
            await google.script.run
                .withSuccessHandler(result => {
                    const response = JSON.parse(result);
                    alert(response.message);
                    
                    if (response.success) {
                        resetForm();
                        setDuplicateWarning(false);
                        setShowPinInput(false);
                        setManagementPin('');
                        setCalculatedMetrics(null);
                        setSelectedDate(new Date().toISOString().split('T')[0]);
                    }
                    setLoading(false);
                })
                .withFailureHandler(error => {
                    alert('Error saving entry: ' + error.message);
                    setLoading(false);
                })
                .saveDailyEntry(entryData);
                
        } catch (error) {
            alert('Error submitting form: ' + error.message);
            setLoading(false);
        }
    };
    
    const resetForm = () => {
        setFormData({
            shawarmaStack: {
                starting_weight: '', remaining_weight: '', shaving_weight: '',
                staff_meals_weight: '', orders_weight: ''
            },
            rawProteins: {
                frozen_chicken_breast_opening: '', frozen_chicken_breast_received: '', 
                frozen_chicken_breast_expired: '', frozen_chicken_breast_remaining: '',
                chicken_shawarma_opening: '', chicken_shawarma_received: '', 
                chicken_shawarma_expired: '', chicken_shawarma_remaining: '',
                steak_opening: '', steak_received: '', steak_expired: '', steak_remaining: ''
            },
            marinatedProteins: {
                fahita_chicken_opening: '', fahita_chicken_received: '', fahita_chicken_expired: '', fahita_chicken_remaining: '',
                chicken_sub_opening: '', chicken_sub_received: '', chicken_sub_expired: '', chicken_sub_remaining: '',
                spicy_strips_opening: '', spicy_strips_received: '', spicy_strips_expired: '', spicy_strips_remaining: '',
                original_strips_opening: '', original_strips_received: '', original_strips_expired: '', original_strips_remaining: '',
    // ADD THIS LINE:
    marinated_steak_opening: '', marinated_steak_received: '', marinated_steak_expired: '', marinated_steak_remaining: ''
            },
            bread: {
                saj_bread_opening: '', saj_bread_received: '', saj_bread_expired: '', saj_bread_remaining: '',
                pita_bread_opening: '', pita_bread_received: '', pita_bread_expired: '', pita_bread_remaining: '',
                bread_rolls_opening: '', bread_rolls_received: '', bread_rolls_expired: '', bread_rolls_remaining: ''
            },
            highCostItems: {
                cream_opening: '', cream_received: '', cream_expired: '', cream_remaining: '',
                mayo_opening: '', mayo_received: '', mayo_expired: '', mayo_remaining: ''
            },
            sales: {
                total_revenue: '',
                shawarma_revenue: '',
                cash_sales: '',
                card_sales: '',
                delivery_aggregator_1: '',
                delivery_aggregator_2: '',
                other_food_revenue: '',
                petty_cash_total: ''
            },
            notes: ''
        });
        setPettyCashEntries([]);
        setIsUpdateMode(false);
    };
    
    const confirmLoadExistingData = async () => {
        if (!loadExistingPin || loadExistingPin.trim() === '') {
            return;
        }
        
        setLoadingExistingData(true);
        setPinError(false);
        setPinAttempted(true);
        
        try {
            await google.script.run
                .withSuccessHandler(isValid => {
                    if (!isValid) {
                        setLoadingExistingData(false);
                        setPinError(true);
                        return;
                    }
                    
                    setPinError(false);
                    
                    google.script.run
                        .withSuccessHandler(dataResult => {
                            try {
                                const data = JSON.parse(dataResult);

                                if (!data.dataFound) {
                                    resetFormToClean();
                                    return;
                                }

                                const inventoryData = data.inventory ? convertInventoryDataToNestedFormat(data.inventory) : {
                                    rawProteins: data.rawProteins || {},
                                    marinatedProteins: data.marinatedProteins || {},
                                    bread: data.bread || {},
                                    highCostItems: data.highCostItems || {}
                                };

                                // Load full data into form (ALL SECTIONS)
                                setFormData(prev => ({
                                    ...prev,
                                    shawarmaStack: {
                                        starting_weight: data.shawarma ? String(data.shawarma.starting_weight_kg || '') : '',
                                        remaining_weight: data.shawarma ? String(data.shawarma.remaining_weight_kg || '') : '',
                                        shaving_weight: data.shawarma ? String(data.shawarma.shaving_weight_kg || '') : '',
                                        staff_meals_weight: data.shawarma ? String(data.shawarma.staff_meals_weight_kg || '') : '',
                                        orders_weight: data.shawarma ? String(data.shawarma.orders_weight_kg || '') : ''
                                    },
                                    sales: {
                                        total_revenue: data.sales ? String(data.sales.total_revenue || '') : '',
                                        shawarma_revenue: data.sales ? String(data.sales.shawarma_revenue || '') : '',
                                        cash_sales: data.sales ? String(data.sales.cash_sales || '') : '',
                                        card_sales: data.sales ? String(data.sales.card_sales || '') : '',
                                        delivery_aggregator_1: data.sales ? String(data.sales.delivery_aggregator_1 || '') : '',
                                        delivery_aggregator_2: data.sales ? String(data.sales.delivery_aggregator_2 || '') : '',
                                        other_food_revenue: data.sales ? String(data.sales.other_food_revenue || '') : '',
                                        petty_cash_total: data.sales ? String(data.sales.petty_cash_total || '') : ''
                                    },
                                    rawProteins: {
                                        frozen_chicken_breast_opening: String(inventoryData.rawProteins.frozen_chicken_breast_opening || ''),
                                        frozen_chicken_breast_received: String(inventoryData.rawProteins.frozen_chicken_breast_received || ''),
                                        frozen_chicken_breast_expired: String(inventoryData.rawProteins.frozen_chicken_breast_expired || ''),
                                        frozen_chicken_breast_remaining: String(inventoryData.rawProteins.frozen_chicken_breast_remaining || ''),
                                        chicken_shawarma_opening: String(inventoryData.rawProteins.chicken_shawarma_opening || ''),
                                        chicken_shawarma_received: String(inventoryData.rawProteins.chicken_shawarma_received || ''),
                                        chicken_shawarma_expired: String(inventoryData.rawProteins.chicken_shawarma_expired || ''),
                                        chicken_shawarma_remaining: String(inventoryData.rawProteins.chicken_shawarma_remaining || ''),
                                        steak_opening: String(inventoryData.rawProteins.steak_opening || ''),
                                        steak_received: String(inventoryData.rawProteins.steak_received || ''),
                                        steak_expired: String(inventoryData.rawProteins.steak_expired || ''),
                                        steak_remaining: String(inventoryData.rawProteins.steak_remaining || '')
                                    },
                                    marinatedProteins: {
                                        fahita_chicken_opening: String(inventoryData.marinatedProteins.fahita_chicken_opening || ''),
                                        fahita_chicken_received: String(inventoryData.marinatedProteins.fahita_chicken_received || ''),
                                        fahita_chicken_expired: String(inventoryData.marinatedProteins.fahita_chicken_expired || ''),
                                        fahita_chicken_remaining: String(inventoryData.marinatedProteins.fahita_chicken_remaining || ''),
                                        chicken_sub_opening: String(inventoryData.marinatedProteins.chicken_sub_opening || ''),
                                        chicken_sub_received: String(inventoryData.marinatedProteins.chicken_sub_received || ''),
                                        chicken_sub_expired: String(inventoryData.marinatedProteins.chicken_sub_expired || ''),
                                        chicken_sub_remaining: String(inventoryData.marinatedProteins.chicken_sub_remaining || ''),
                                        spicy_strips_opening: String(inventoryData.marinatedProteins.spicy_strips_opening || ''),
                                        spicy_strips_received: String(inventoryData.marinatedProteins.spicy_strips_received || ''),
                                        spicy_strips_expired: String(inventoryData.marinatedProteins.spicy_strips_expired || ''),
                                        spicy_strips_remaining: String(inventoryData.marinatedProteins.spicy_strips_remaining || ''),
                    original_strips_opening: String(inventoryData.marinatedProteins.original_strips_opening || ''),
                    original_strips_received: String(inventoryData.marinatedProteins.original_strips_received || ''),
                    original_strips_expired: String(inventoryData.marinatedProteins.original_strips_expired || ''),
                    original_strips_remaining: String(inventoryData.marinatedProteins.original_strips_remaining || ''),
                    marinated_steak_opening: String(inventoryData.marinatedProteins.marinated_steak_opening || ''),
                    marinated_steak_received: String(inventoryData.marinatedProteins.marinated_steak_received || ''),
                    marinated_steak_expired: String(inventoryData.marinatedProteins.marinated_steak_expired || ''),
                    marinated_steak_remaining: String(inventoryData.marinatedProteins.marinated_steak_remaining || '')
                                    },
                                    bread: {
                                        saj_bread_opening: String(inventoryData.bread.saj_bread_opening || ''),
                                        saj_bread_received: String(inventoryData.bread.saj_bread_received || ''),
                                        saj_bread_expired: String(inventoryData.bread.saj_bread_expired || ''),
                                        saj_bread_remaining: String(inventoryData.bread.saj_bread_remaining || ''),
                                        pita_bread_opening: String(inventoryData.bread.pita_bread_opening || ''),
                                        pita_bread_received: String(inventoryData.bread.pita_bread_received || ''),
                                        pita_bread_expired: String(inventoryData.bread.pita_bread_expired || ''),
                    pita_bread_remaining: String(inventoryData.bread.pita_bread_remaining || ''),
                    bread_rolls_opening: String(inventoryData.bread.bread_rolls_opening || ''),
                    bread_rolls_received: String(inventoryData.bread.bread_rolls_received || ''),
                    bread_rolls_expired: String(inventoryData.bread.bread_rolls_expired || ''),
                    bread_rolls_remaining: String(inventoryData.bread.bread_rolls_remaining || '')
                                    },
                                    highCostItems: {
                                        cream_opening: String(inventoryData.highCostItems.cream_opening || ''),
                    cream_received: String(inventoryData.highCostItems.cream_received || ''),
                    cream_expired: String(inventoryData.highCostItems.cream_expired || ''),
                    cream_remaining: String(inventoryData.highCostItems.cream_remaining || ''),
                    mayo_opening: String(inventoryData.highCostItems.mayo_opening || ''),
                    mayo_received: String(inventoryData.highCostItems.mayo_received || ''),
                    mayo_expired: String(inventoryData.highCostItems.mayo_expired || ''),
                    mayo_remaining: String(inventoryData.highCostItems.mayo_remaining || '')
                                    },
                                    notes: data.notes || ''
                                }));
                                setPettyCashEntries(data.pettyCashEntries || []);

                                setFieldsLocked(false);
                                setIsUpdateMode(true);
                                setDuplicateWarning(false);
                                setShowLoadExistingPin(false);
                                setLoadExistingPin('');
                                setLoadingExistingData(false);
                                setPinError(false);
                                setPinAttempted(false);
                                
                            } catch (parseError) {
                                console.error('Data parsing error:', parseError);
                                setLoadingExistingData(false);
                            }
                        })
                        .withFailureHandler(error => {
                            console.error('Data loading error:', error);
                            setLoadingExistingData(false);
                        })
                        .generateDailyReport(selectedDate);
                })
                .withFailureHandler(error => {
                    console.error('PIN validation error:', error);
                    setLoadingExistingData(false);
                    setPinError(true);
                })
                .validateManagementPin(loadExistingPin);
                
        } catch (error) {
            console.error('Function error:', error);
            setLoadingExistingData(false);
            setPinError(true);
        }
    };

    const resetFormToClean = () => {
        setFormData({
            shawarmaStack: {
                starting_weight: '', remaining_weight: '', shaving_weight: '',
                staff_meals_weight: '', orders_weight: ''
            },
            rawProteins: {
                frozen_chicken_breast_opening: '', frozen_chicken_breast_received: '', 
                frozen_chicken_breast_expired: '', frozen_chicken_breast_remaining: '',
                chicken_shawarma_opening: '', chicken_shawarma_received: '', 
                chicken_shawarma_expired: '', chicken_shawarma_remaining: '',
                steak_opening: '', steak_received: '', steak_expired: '', steak_remaining: ''
            },
            marinatedProteins: {
                fahita_chicken_opening: '', fahita_chicken_received: '', fahita_chicken_expired: '', fahita_chicken_remaining: '',
                chicken_sub_opening: '', chicken_sub_received: '', chicken_sub_expired: '', chicken_sub_remaining: '',
                spicy_strips_opening: '', spicy_strips_received: '', spicy_strips_expired: '', spicy_strips_remaining: '',
                original_strips_opening: '', original_strips_received: '', original_strips_expired: '', original_strips_remaining: '',
    // ADD THIS LINE:
    marinated_steak_opening: '', marinated_steak_received: '', marinated_steak_expired: '', marinated_steak_remaining: ''
            },
            bread: {
                saj_bread_opening: '', saj_bread_received: '', saj_bread_expired: '', saj_bread_remaining: '',
                pita_bread_opening: '', pita_bread_received: '', pita_bread_expired: '', pita_bread_remaining: '',
                bread_rolls_opening: '', bread_rolls_received: '', bread_rolls_expired: '', bread_rolls_remaining: ''
            },
            highCostItems: {
                cream_opening: '', cream_received: '', cream_expired: '', cream_remaining: '',
                mayo_opening: '', mayo_received: '', mayo_expired: '', mayo_remaining: ''
            },
            sales: {
                total_revenue: '',
                shawarma_revenue: '',
                cash_sales: '',
                card_sales: '',
                delivery_aggregator_1: '',
                delivery_aggregator_2: '',
                other_food_revenue: '',
                petty_cash_total: ''
            },
            notes: ''
        });

        setDuplicateWarning(false);
        setIsUpdateMode(false);
        setPettyCashEntries([]);
        setFieldsLocked(false);
        setShowLoadExistingPin(false);
        setLoadExistingPin('');
        setLoadingExistingData(false);
        setPinError(false);
        setPinAttempted(false);
    };
    
    const cancelLoadExisting = () => {
        setShowLoadExistingPin(false);
        setLoadExistingPin('');
    };
    
    const cancelUpdate = () => {
        setShowPinInput(false);
        setManagementPin('');
        setFieldsLocked(false);
    };

    const calculateOtherFoodRevenue = () => {
        const total = parseFloat(formData.sales.total_revenue) || 0;
        const shawarma = parseFloat(formData.sales.shawarma_revenue) || 0;
        return total - shawarma;
    };

    const calculatePettyCashTotal = () => {
        return pettyCashEntries.reduce((sum, entry) => sum + (parseFloat(entry.amount) || 0), 0);
    };

    const handleAddPettyCashEntry = () => {
        const { category, description, amount, paid_by } = currentPettyCashEntry;
        if (!category || !description || !amount || !paid_by) {
            alert(t('fieldRequired'));
            return;
        }
        if (parseFloat(amount) <= 0) {
            alert(t('amountMustBePositive'));
            return;
        }
        setPettyCashEntries([...pettyCashEntries, { ...currentPettyCashEntry, id: Date.now().toString() }]);
        resetPettyCashForm();
    };

    const handleEditPettyCashEntry = (index) => {
        setCurrentPettyCashEntry(pettyCashEntries[index]);
        setEditingEntryIndex(index);
    };

    const handleUpdatePettyCashEntry = () => {
        if (editingEntryIndex < 0) return;
        const updated = [...pettyCashEntries];
        updated[editingEntryIndex] = currentPettyCashEntry;
        setPettyCashEntries(updated);
        resetPettyCashForm();
    };

    const handleDeletePettyCashEntry = (index) => {
        if (confirm(t('confirmDeleteEntry'))) {
            setPettyCashEntries(pettyCashEntries.filter((_, i) => i !== index));
        }
    };

    const handleCancelPettyCashEdit = () => {
        resetPettyCashForm();
    };

    const resetPettyCashForm = () => {
        setCurrentPettyCashEntry({ id: null, category: '', description: '', amount: '', paid_by: '' });
        setEditingEntryIndex(-1);
    };

    React.useEffect(() => {
        setFormData(prev => ({
            ...prev,
            sales: { ...prev.sales, petty_cash_total: String(calculatePettyCashTotal().toFixed(2)) }
        }));
    }, [pettyCashEntries]);
    
    const renderInventorySection = (title, sectionKey, items, unit, description) => {
        return React.createElement('div', {
            className: 'mb-6'
        },
            React.createElement('h4', {
                className: 'font-medium text-gray-700 mb-3'
            }, title + (description ? ' (' + description + ')' : '')),
            React.createElement('div', {
                className: 'overflow-x-auto'
            },
                React.createElement('table', {
                    className: 'min-w-full border-collapse'
                },
                    React.createElement('thead', null,
                        React.createElement('tr', {
                            className: 'bg-gray-50'
                        },
                            React.createElement('th', {
                                className: 'border border-gray-200 px-3 py-2 text-left text-xs font-medium text-gray-600 w-32'
                            }, 'Item'),
                            React.createElement('th', {
                                className: 'border border-gray-200 px-3 py-2 text-left text-xs font-medium text-gray-600 w-20'
                            }, 'Opening'),
                            React.createElement('th', {
                                className: 'border border-gray-200 px-3 py-2 text-left text-xs font-medium text-gray-600 w-20'
                            }, 'Received'),
                            React.createElement('th', {
                                className: 'border border-gray-200 px-3 py-2 text-left text-xs font-medium text-gray-600 w-20'
                            }, 'Expired'),
                            React.createElement('th', {
                                className: 'border border-gray-200 px-3 py-2 text-left text-xs font-medium text-gray-600 w-20'
                            }, 'Remaining'),
                            React.createElement('th', {
                                className: 'border border-gray-200 px-3 py-2 text-left text-xs font-medium text-gray-600 w-20'
                            }, 'Usage')
                        )
                    ),
                    React.createElement('tbody', null,
                        items.map(item => 
                            React.createElement('tr', {
                                key: item.key,
                                className: 'hover:bg-gray-50'
                            },
                                React.createElement('td', {
                                    className: 'border border-gray-200 px-3 py-2 text-sm font-medium text-gray-700'
                                }, item.label),
                                React.createElement('td', {
                                    className: 'border border-gray-200 px-2 py-1'
                                },
                                    React.createElement('input', {
                                        type: 'number',
                                        step: unit === 'kg' ? '0.001' : '1',
                                        value: formData[sectionKey][item.key + '_opening'],
                                        onChange: e => handleInputChange(sectionKey, item.key + '_opening', e.target.value),
                                        className: 'w-full p-1 border rounded text-xs bg-gray-100' + (checkingExistingData || fieldsLocked ? ' opacity-50' : ''),
                                        placeholder: '0',
                                        readOnly: true,
                                        disabled: checkingExistingData || fieldsLocked
                                    })
                                ),
                                React.createElement('td', {
                                    className: 'border border-gray-200 px-2 py-1'
                                },
                                    React.createElement('input', {
                                        type: 'number',
                                        step: unit === 'kg' ? '0.001' : '1',
                                        value: formData[sectionKey][item.key + '_received'],
                                        onChange: e => handleInputChange(sectionKey, item.key + '_received', e.target.value),
                                        className: 'w-full p-1 border rounded text-xs' + (checkingExistingData || fieldsLocked ? ' bg-gray-100 opacity-50' : ''),
                                        placeholder: '0',
                                        disabled: checkingExistingData || fieldsLocked
                                    })
                                ),
                                React.createElement('td', {
                                    className: 'border border-gray-200 px-2 py-1'
                                },
                                    React.createElement('input', {
                                        type: 'number',
                                        step: unit === 'kg' ? '0.001' : '1',
                                        value: formData[sectionKey][item.key + '_expired'],
                                        onChange: e => handleInputChange(sectionKey, item.key + '_expired', e.target.value),
                                        className: 'w-full p-1 border rounded text-xs' + (fieldsLocked ? ' bg-gray-100' : ''),
                                        placeholder: '0',
                                        disabled: fieldsLocked
                                    })
                                ),
                                React.createElement('td', {
                                    className: 'border border-gray-200 px-2 py-1'
                                },
                                    React.createElement('input', {
                                        type: 'number',
                                        step: unit === 'kg' ? '0.001' : '1',
                                        value: formData[sectionKey][item.key + '_remaining'],
                                        onChange: e => handleInputChange(sectionKey, item.key + '_remaining', e.target.value),
                                        className: 'w-full p-1 border rounded text-xs' + (fieldsLocked ? ' bg-gray-100' : ''),
                                        placeholder: '0',
                                        required: true,
                                        disabled: fieldsLocked
                                    })
                                ),
                                React.createElement('td', {
                                    className: 'border border-gray-200 px-2 py-1 text-xs text-gray-600 text-center bg-blue-50'
                                }, calculatedMetrics && calculatedMetrics.usage ? calculatedMetrics.usage[sectionKey + '_' + item.key + '_usage'] || '0' : '0')
                            )
                        )
                    )
                )
            )
        );
    };
    
    return React.createElement('div', {
        className: 'max-w-6xl mx-auto space-y-6'
    },
        React.createElement(PettyCashModal, {
            open: showPettyCashModal,
            onClose: () => { setShowPettyCashModal(false); handleCancelPettyCashEdit(); },
            entries: pettyCashEntries,
            entry: currentPettyCashEntry,
            setEntry: setCurrentPettyCashEntry,
            editingIndex: editingEntryIndex,
            onAdd: handleAddPettyCashEntry,
            onUpdate: handleUpdatePettyCashEntry,
            onEdit: handleEditPettyCashEntry,
            onDelete: handleDeletePettyCashEntry,
            onCancel: handleCancelPettyCashEdit,
            categories: PETTY_CASH_CATEGORIES,
            t: t
        }),
        React.createElement('div', {
            className: 'bg-white rounded-lg shadow p-6'
        },
            React.createElement('h2', {
                className: 'text-2xl font-bold text-gray-800 mb-6'
            }, 'Daily Operations Entry'),

            React.createElement(EmployeeContextDisplay, { employee: employeeContext, t: t }),

            // Date Selection and Status
            React.createElement('div', {
                className: 'mb-6 p-4 bg-blue-50 rounded-lg'
            },
                React.createElement('div', {
                    className: 'flex items-center gap-4'
                },
                    React.createElement('div', null,
                        React.createElement('label', {
                            className: 'block text-sm font-medium mb-1'
                        }, 'Select Date'),
                        React.createElement('input', {
                            type: 'date',
                            value: selectedDate,
                            max: new Date().toISOString().split('T')[0],
                            onChange: e => setSelectedDate(e.target.value),
                            className: 'p-2 border rounded focus:ring-2 focus:ring-blue-500'
                        })
                    ),
                    
                    // Loading indicator
                    checkingExistingData && React.createElement('div', {
                        className: 'flex items-center gap-2 text-gray-600'
                    },
                        React.createElement('div', {
                            className: 'animate-spin rounded-full h-4 w-4 border-b-2 border-gray-600'
                        }),
                        React.createElement('span', {
                            className: 'text-sm'
                        }, 'Checking for existing data...')
                    ),
                    
                    // Status messages
                    !checkingExistingData && React.createElement('div', {
                        className: 'flex-1'
                    },
                        // PIN input section if data exists
                        duplicateWarning && showLoadExistingPin && React.createElement('div', {
                            className: 'bg-yellow-100 border border-yellow-400 rounded p-3'
                        },
                            React.createElement('div', {
                                className: 'flex items-center gap-2 mb-3'
                            },
                                React.createElement('span', {
                                    className: 'text-yellow-600'
                                }, '⚠️'),
                                React.createElement('div', {
                                    className: 'flex-1'
                                },
                                    React.createElement('p', {
                                        className: 'font-medium text-yellow-800'
                                    }, 'Entry exists for ' + selectedDate),
                                    React.createElement('p', {
                                        className: 'text-sm text-yellow-600'
                                    }, 'Enter PIN to load data')
                                )
                            ),
                            
                            // PIN input
                            React.createElement('div', {
                                className: 'bg-blue-50 border border-blue-300 rounded-lg p-3'
                            },
                                React.createElement('h4', {
                                    className: 'text-sm font-semibold text-blue-800 mb-2'
                                }, '🔐 Management PIN'),
                                
                                loadingExistingData ? React.createElement('div', {
                                    className: 'flex items-center gap-2 text-blue-600'
                                },
                                    React.createElement('div', {
                                        className: 'animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600'
                                    }),
                                    React.createElement('span', {
                                        className: 'text-sm'
                                    }, 'Loading data...')
                                ) : React.createElement('div', null,
                                    React.createElement('div', {
                                        className: 'flex items-center gap-2'
                                    },
                                        React.createElement('input', {
                                            type: 'password',
                                            value: loadExistingPin,
                                            onChange: e => {
                                                setLoadExistingPin(e.target.value);
                                                if (pinError) {
                                                    setPinError(false);
                                                }
                                            },
                                            onKeyPress: e => {
                                                if (e.key === 'Enter' && loadExistingPin.trim()) {
                                                    confirmLoadExistingData();
                                                }
                                            },
                                            className: 'flex-1 p-2 border rounded text-sm',
                                            placeholder: 'Enter PIN'
                                        }),
                                        React.createElement('button', {
                                            type: 'button',
                                            onClick: confirmLoadExistingData,
                                            disabled: !loadExistingPin,
                                            className: 'bg-blue-600 text-white px-3 py-2 rounded text-sm disabled:opacity-50'
                                        }, 'Unlock')
                                    ),
                                    
                                    pinError && pinAttempted && !loadingExistingData && React.createElement('div', {
                                        className: 'mt-2'
                                    },
                                        React.createElement('p', {
                                            className: 'text-xs text-red-600'
                                        }, 'Incorrect PIN. Please try again.')
                                    )
                                )
                            )
                        ),
                        
                        // Success message when data is loaded
                        !duplicateWarning && selectedDate !== new Date().toISOString().split('T')[0] && React.createElement('div', {
                            className: 'bg-green-100 border border-green-400 rounded p-3'
                        },
                            React.createElement('div', {
                                className: 'flex items-center gap-2'
                            },
                                React.createElement('span', {
                                    className: 'text-green-600'
                                }, '✅'),
                                React.createElement('p', {
                                    className: 'text-green-800 text-sm'
                                }, 'Data loaded for ' + selectedDate + ' - Form ready for editing')
                            )
                        ),
                        
                        // New entry message for today
                        !duplicateWarning && selectedDate === new Date().toISOString().split('T')[0] && React.createElement('div', {
                            className: 'bg-blue-100 border border-blue-400 rounded p-3'
                        },
                            React.createElement('div', {
                                className: 'flex items-center gap-2'
                            },
                                React.createElement('span', {
                                    className: 'text-blue-600'
                                }, '📝'),
                                React.createElement('p', {
                                    className: 'text-blue-800 text-sm'
                                }, 'Ready for new entry - ' + selectedDate)
                            )
                        )
                    )
                )
            ),
            
            React.createElement('form', {
                onSubmit: handleSubmit,
                className: 'space-y-8'
            },
                
                // Shawarma Stack Section (NO revenue field - as agreed)
                React.createElement('div', {
                    className: 'border border-gray-200 rounded-lg p-6'
                },
                    React.createElement('h3', {
                        className: 'text-lg font-semibold text-gray-800 mb-4 flex items-center'
                    },
                        React.createElement('span', null, '🥙 Shawarma Stack Management'),
                        React.createElement('span', {
                            className: 'ml-2 text-sm font-normal text-gray-600'
                        }, '(Fresh daily - dynamic waste tracking)')
                    ),
                    
                    React.createElement('div', {
                        className: 'grid grid-cols-2 md:grid-cols-3 gap-4'
                    },
                        React.createElement('div', null,
                            React.createElement('label', {
                                className: 'block text-sm font-medium mb-1'
                            }, 'Starting Weight (kg)'),
                            React.createElement('input', {
                                type: 'number',
                                step: '0.001',
                                value: formData.shawarmaStack.starting_weight,
                                onChange: e => handleInputChange('shawarmaStack', 'starting_weight', e.target.value),
                                className: 'w-full p-2 border rounded focus:ring-2 focus:ring-olive-500' + (fieldsLocked ? ' bg-gray-100' : ''),
                                required: true,
                                disabled: fieldsLocked
                            })
                        ),
                        
                        React.createElement('div', null,
                            React.createElement('label', {
                                className: 'block text-sm font-medium mb-1'
                            }, 'Orders Weight (kg)'),
                            React.createElement('input', {
                                type: 'number',
                                step: '0.001',
                                value: formData.shawarmaStack.orders_weight,
                                onChange: e => handleInputChange('shawarmaStack', 'orders_weight', e.target.value),
                                className: 'w-full p-2 border rounded focus:ring-2 focus:ring-olive-500' + (fieldsLocked ? ' bg-gray-100' : ''),
                                disabled: fieldsLocked
                            })
                        ),
                        
                        React.createElement('div', null,
                            React.createElement('label', {
                                className: 'block text-sm font-medium mb-1'
                            }, 'Shaving Weight (kg)'),
                            React.createElement('input', {
                                type: 'number',
                                step: '0.001',
                                value: formData.shawarmaStack.shaving_weight,
                                onChange: e => handleInputChange('shawarmaStack', 'shaving_weight', e.target.value),
                                className: 'w-full p-2 border rounded focus:ring-2 focus:ring-olive-500' + (fieldsLocked ? ' bg-gray-100' : ''),
                                disabled: fieldsLocked
                            })
                        ),
                        
                        React.createElement('div', null,
                            React.createElement('label', {
                                className: 'block text-sm font-medium mb-1'
                            }, 'Staff Meals (kg)'),
                            React.createElement('input', {
                                type: 'number',
                                step: '0.001',
                                value: formData.shawarmaStack.staff_meals_weight,
                                onChange: e => handleInputChange('shawarmaStack', 'staff_meals_weight', e.target.value),
                                className: 'w-full p-2 border rounded focus:ring-2 focus:ring-olive-500' + (fieldsLocked ? ' bg-gray-100' : ''),
                                disabled: fieldsLocked
                            }),
                            React.createElement('p', {
                                className: 'text-xs text-gray-500 mt-1'
                            }, 'Limit: 0.4kg')
                        ),
                        
                        React.createElement('div', null,
                            React.createElement('label', {
                                className: 'block text-sm font-medium mb-1'
                            }, 'Remaining Weight (kg)'),
                            React.createElement('input', {
                                type: 'number',
                                step: '0.001',
                                value: formData.shawarmaStack.remaining_weight,
                                onChange: e => handleInputChange('shawarmaStack', 'remaining_weight', e.target.value),
                                className: 'w-full p-2 border rounded focus:ring-2 focus:ring-olive-500' + (fieldsLocked ? ' bg-gray-100' : ''),
                                required: true,
                                disabled: fieldsLocked
                            }),
                            React.createElement('p', {
                                className: 'text-xs text-gray-500 mt-1'
                            }, calculatedMetrics && calculatedMetrics.ranges ? 
                                `Target: ${(calculatedMetrics.ranges.remainingRange.min * 1000).toFixed(0)}-${(calculatedMetrics.ranges.remainingRange.max * 1000).toFixed(0)}g` : 
                                'Dynamic range (600-850g)')
                        )
                    ),
                    
                    // Enhanced Calculated Metrics Display with dynamic ranges and alerts
                    calculatedMetrics && React.createElement('div', {
                        className: 'mt-6 space-y-4'
                    },
                        // Alerts section
                        calculatedMetrics.alerts && calculatedMetrics.alerts.length > 0 && React.createElement('div', {
                            className: 'bg-red-50 border border-red-200 rounded-lg p-4'
                        },
                            React.createElement('h4', {
                                className: 'font-medium text-red-800 mb-2 flex items-center'
                            },
                                React.createElement('span', null, '🚨'),
                                React.createElement('span', {
                                    className: 'ml-2'
                                }, 'Performance Alerts')
                            ),
                            React.createElement('div', {
                                className: 'space-y-2'
                            },
                                calculatedMetrics.alerts.map((alert, index) =>
                                    React.createElement('div', {
                                        key: index,
                                        className: `text-sm p-2 rounded ${alert.type === 'danger' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}`
                                    }, alert.message)
                                )
                            )
                        ),
                        
                        // Metrics display
                        React.createElement('div', {
                            className: 'p-4 bg-gray-50 rounded-lg'
                        },
                            React.createElement('h4', {
                                className: 'font-medium text-gray-800 mb-3'
                            }, 'Calculated Metrics:'),
                            React.createElement('div', {
                                className: 'grid grid-cols-1 md:grid-cols-3 gap-6'
                            },
                                // Loss metrics (fixed range)
                                React.createElement('div', {
                                    className: 'bg-white p-3 rounded border'
                                },
                                    React.createElement('h5', {
                                        className: 'font-medium text-gray-700 mb-2'
                                    }, '🔥 Cooking Loss'),
                                    React.createElement('div', {
                                        className: 'space-y-1 text-sm'
                                    },
                                        React.createElement('div', null,
                                            React.createElement('span', {
                                                className: 'text-gray-600'
                                            }, 'Weight: '),
                                            React.createElement('span', {
                                                className: 'font-medium'
                                            }, calculatedMetrics.shawarma.lossWeight + ' kg')
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('span', {
                                                className: 'text-gray-600'
                                            }, 'Percentage: '),
                                            React.createElement('span', {
                                                className: `font-medium ${
                                                    parseFloat(calculatedMetrics.shawarma.lossPercentage) > 28 ? 'text-red-600' :
                                                    parseFloat(calculatedMetrics.shawarma.lossPercentage) > 25 ? 'text-yellow-600' : 'text-green-600'
                                                }`
                                            }, calculatedMetrics.shawarma.lossPercentage + '%')
                                        ),
                                        React.createElement('div', {
                                            className: 'text-xs text-gray-500 mt-1'
                                        }, 'Target: 12-28%')
                                    )
                                ),
                                
                                // Total waste metrics (dynamic range)
                                React.createElement('div', {
                                    className: 'bg-white p-3 rounded border'
                                },
                                    React.createElement('h5', {
                                        className: 'font-medium text-gray-700 mb-2'
                                    }, '🗑️ Total Waste'),
                                    React.createElement('div', {
                                        className: 'space-y-1 text-sm'
                                    },
                                        React.createElement('div', null,
                                            React.createElement('span', {
                                                className: 'text-gray-600'
                                            }, 'Weight: '),
                                            React.createElement('span', {
                                                className: 'font-medium'
                                            }, calculatedMetrics.shawarma.totalWasteWeight + ' kg')
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('span', {
                                                className: 'text-gray-600'
                                            }, 'Percentage: '),
                                            React.createElement('span', {
                                                className: `font-medium ${
                                                    calculatedMetrics.ranges && parseFloat(calculatedMetrics.shawarma.totalWastePercentage) > calculatedMetrics.ranges.totalWasteRange.max ? 'text-red-600' : 'text-green-600'
                                                }`
                                            }, calculatedMetrics.shawarma.totalWastePercentage + '%')
                                        ),
                                        React.createElement('div', {
                                            className: 'text-xs text-gray-500 mt-1'
                                        }, calculatedMetrics.ranges ? 
                                            `Target: ${calculatedMetrics.ranges.totalWasteRange.min.toFixed(1)}-${calculatedMetrics.ranges.totalWasteRange.max.toFixed(1)}%` : 
                                            'Dynamic range')
                                    )
                                ),
                                
                                // Performance metrics
                                React.createElement('div', {
                                    className: 'bg-white p-3 rounded border'
                                },
                                    React.createElement('h5', {
                                        className: 'font-medium text-gray-700 mb-2'
                                    }, '📊 Performance'),
                                    React.createElement('div', {
                                        className: 'space-y-1 text-sm'
                                    },
                                        React.createElement('div', null,
                                            React.createElement('span', {
                                                className: 'text-gray-600'
                                            }, 'Revenue/kg: '),
                                            React.createElement('span', {
                                                className: 'font-medium text-blue-600'
                                            }, calculatedMetrics.shawarma.revenuePerKg + ' QAR')
                                        ),
                                        React.createElement('div', null,
                                            React.createElement('span', {
                                                className: 'text-gray-600'
                                            }, 'Staff Meals: '),
                                            React.createElement('span', {
                                                className: `font-medium ${
                                                    parseFloat(formData.shawarmaStack.staff_meals_weight) > 0.4 ? 'text-red-600' : 'text-green-600'
                                                }`
                                            }, ((parseFloat(formData.shawarmaStack.staff_meals_weight) || 0) * 1000).toFixed(0) + 'g')
                                        ),
                                        React.createElement('div', {
                                            className: 'text-xs text-gray-500 mt-1'
                                        }, 'Remaining target: ' + (calculatedMetrics.ranges ? 
                                            `${(calculatedMetrics.ranges.remainingRange.optimal * 1000).toFixed(0)}g` : '600-800g'))
                                    )
                                )
                            )
                        )
                    )
                ),
                
                // Raw Proteins Section
                React.createElement('div', {
                    className: 'border border-gray-200 rounded-lg p-6'
                },
                    React.createElement('h3', {
                        className: 'text-lg font-semibold text-gray-800 mb-4 flex items-center'
                    },
                        React.createElement('span', null, '🥩 Raw Proteins'),
                        React.createElement('span', {
                            className: 'ml-2 text-sm font-normal text-gray-600'
                        }, '(Carry forward from previous day)')
                    ),
                    
                    renderInventorySection(
                        INVENTORY_CONFIG.rawProteins.titleKey,
                        'rawProteins',
                        INVENTORY_CONFIG.rawProteins.items,
                        'kg',
                        'kg'
                    )
                ),
                
                // Marinated Proteins Section
                React.createElement('div', {
                    className: 'border border-gray-200 rounded-lg p-6'
                },
                    React.createElement('h3', {
                        className: 'text-lg font-semibold text-gray-800 mb-4 flex items-center'
                    },
                        React.createElement('span', null, '🍖 Marinated Ready-to-Use'),
                        React.createElement('span', {
                            className: 'ml-2 text-sm font-normal text-gray-600'
                        }, '(Carry forward from previous day)')
                    ),
                    renderInventorySection(
                        INVENTORY_CONFIG.marinatedProteins.titleKey,
                        'marinatedProteins',
                        INVENTORY_CONFIG.marinatedProteins.items,
                        'kg',
                        'kg'
                    )
                ),
                
                // Bread Section
                React.createElement('div', {
                    className: 'border border-gray-200 rounded-lg p-6'
                },
                    React.createElement('h3', {
                        className: 'text-lg font-semibold text-gray-800 mb-4 flex items-center'
                    },
                        React.createElement('span', null, '🍞 Daily Bread Tracking'),
                        React.createElement('span', {
                            className: 'ml-2 text-sm font-normal text-gray-600'
                        }, '(Carry forward from previous day)')
                    ),
                    
                    renderInventorySection(
                        INVENTORY_CONFIG.bread.titleKey,
                        'bread',
                        INVENTORY_CONFIG.bread.items,
                        'pieces',
                        'pieces'
                    )
                ),
                
                // High-Cost Items Section
                React.createElement('div', {
                    className: 'border border-gray-200 rounded-lg p-6'
                },
                    React.createElement('h3', {
                        className: 'text-lg font-semibold text-gray-800 mb-4 flex items-center'
                    },
                        React.createElement('span', null, '💰 High-Cost Items'),
                        React.createElement('span', {
                            className: 'ml-2 text-sm font-normal text-gray-600'
                        }, '(Carry forward from previous day)')
                    ),
                    
                    renderInventorySection(
                        INVENTORY_CONFIG.highCostItems.titleKey,
                        'highCostItems',
                        INVENTORY_CONFIG.highCostItems.items,
                        'kg',
                        'kg'
                    )
                ),
                
                // Sales Section
                React.createElement('div', {
                    className: 'border border-gray-200 rounded-lg p-6 sales-breakdown'
                },
                    React.createElement('h3', {
                        className: 'text-lg font-semibold text-gray-800 mb-4 flex items-center'
                    },
                        React.createElement('span', null, '💵 ' + t('dailySales')),
                        React.createElement('span', {
                            className: 'ml-2 text-sm font-normal text-gray-600'
                        }, '(Includes shawarma revenue for calculations)')
                    ),
                    
                    React.createElement('div', {
                        className: 'grid grid-cols-1 md:grid-cols-2 gap-4'
                    },
                        // Total revenue
                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, t('totalDailyRevenue')),
                            React.createElement('input', {
                                type: 'number',
                                step: '0.01',
                                value: formData.sales.total_revenue,
                                onChange: e => handleInputChange('sales', 'total_revenue', e.target.value),
                                className: 'w-full p-2 border rounded focus:ring-2 focus:ring-olive-500' + (fieldsLocked ? ' bg-gray-100' : ''),
                                required: true,
                                disabled: fieldsLocked
                            })
                        ),
                        // Shawarma revenue
                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, t('shawarmaRevenue')),
                            React.createElement('input', {
                                type: 'number',
                                step: '0.01',
                                value: formData.sales.shawarma_revenue,
                                onChange: e => handleInputChange('sales', 'shawarma_revenue', e.target.value),
                                className: 'w-full p-2 border rounded focus:ring-2 focus:ring-olive-500' + (fieldsLocked ? ' bg-gray-100' : ''),
                                required: true,
                                disabled: fieldsLocked
                            }),
                            React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 'Used for shawarma profitability calculations')
                        ),
                        // Cash sales
                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, t('cashSales')),
                            React.createElement('input', {
                                type: 'number',
                                step: '0.01',
                                value: formData.sales.cash_sales,
                                onChange: e => handleInputChange('sales', 'cash_sales', e.target.value),
                                className: 'w-full p-2 border rounded focus:ring-2 focus:ring-olive-500' + (fieldsLocked ? ' bg-gray-100' : ''),
                                disabled: fieldsLocked
                            })
                        ),
                        // Card sales
                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, t('cardSales')),
                            React.createElement('input', {
                                type: 'number',
                                step: '0.01',
                                value: formData.sales.card_sales,
                                onChange: e => handleInputChange('sales', 'card_sales', e.target.value),
                                className: 'w-full p-2 border rounded focus:ring-2 focus:ring-olive-500' + (fieldsLocked ? ' bg-gray-100' : ''),
                                disabled: fieldsLocked
                            })
                        ),
                        // Delivery platform 1
                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, t('deliveryAggregator1')),
                            React.createElement('input', {
                                type: 'number',
                                step: '0.01',
                                value: formData.sales.delivery_aggregator_1,
                                onChange: e => handleInputChange('sales', 'delivery_aggregator_1', e.target.value),
                                className: 'w-full p-2 border rounded focus:ring-2 focus:ring-olive-500' + (fieldsLocked ? ' bg-gray-100' : ''),
                                disabled: fieldsLocked
                            })
                        ),
                        // Delivery platform 2
                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, t('deliveryAggregator2')),
                            React.createElement('input', {
                                type: 'number',
                                step: '0.01',
                                value: formData.sales.delivery_aggregator_2,
                                onChange: e => handleInputChange('sales', 'delivery_aggregator_2', e.target.value),
                                className: 'w-full p-2 border rounded focus:ring-2 focus:ring-olive-500' + (fieldsLocked ? ' bg-gray-100' : ''),
                                disabled: fieldsLocked
                            })
                        ),
                        // Other food revenue (read-only)
                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, t('otherFoodRevenue')),
                            React.createElement('input', {
                                type: 'number',
                                step: '0.01',
                                value: calculateOtherFoodRevenue().toFixed(2),
                                readOnly: true,
                                className: 'w-full p-2 border rounded bg-gray-100',
                                disabled: true
                            })
                        ),
                        // Petty cash total (read-only)
                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium mb-1' }, t('pettyCashTotal')),
                            React.createElement('input', {
                                type: 'number',
                                step: '0.01',
                                value: calculatePettyCashTotal().toFixed(2),
                                readOnly: true,
                                className: 'w-full p-2 border rounded bg-gray-100',
                                disabled: true
                            })
                        )
                    ),

                    React.createElement('div', { className: 'mt-4' },
                        React.createElement('button', {
                            type: 'button',
                            className: 'bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50',
                            onClick: () => setShowPettyCashModal(true),
                            disabled: fieldsLocked
                        }, t('pettyCash') + ': ' + calculatePettyCashTotal().toFixed(2) + ' QAR (' + pettyCashEntries.length + ' ' + t('entries') + ')')
                    ),
                    
                    // Sales Metrics Display
                    calculatedMetrics && calculatedMetrics.sales && React.createElement('div', {
                        className: 'mt-4 p-4 bg-gray-50 rounded-lg'
                    },
                        React.createElement('h4', {
                            className: 'font-medium text-gray-800 mb-2'
                        }, 'Sales Analysis:'),
                        React.createElement('div', {
                            className: 'grid grid-cols-2 gap-4 text-sm'
                        },
                            React.createElement('div', null,
                                React.createElement('span', {
                                    className: 'text-gray-600'
                                }, 'Shawarma % of Total:'),
                                React.createElement('p', {
                                    className: 'font-medium text-blue-600'
                                }, calculatedMetrics.sales.shawarmaPercentage + '%')
                            ),
                            React.createElement('div', null,
                                React.createElement('span', {
                                    className: 'text-gray-600'
                                }, 'Other Items Revenue:'),
                                React.createElement('p', {
                                    className: 'font-medium text-green-600'
                                }, ((parseFloat(formData.sales.total_revenue) || 0) - (parseFloat(formData.sales.shawarma_revenue) || 0)).toFixed(2) + ' QAR')
                            )
                        )
                    )
                ),
                
                // Notes Section
                React.createElement('div', {
                    className: 'border border-gray-200 rounded-lg p-6'
                },
                    React.createElement('h3', {
                        className: 'text-lg font-semibold text-gray-800 mb-4'
                    }, '📝 Daily Notes'),
                    React.createElement('textarea', {
                        value: formData.notes,
                        onChange: e => setFormData(prev => ({ ...prev, notes: e.target.value })),
                        className: 'w-full p-3 border rounded focus:ring-2 focus:ring-olive-500' + (fieldsLocked ? ' bg-gray-100' : ''),
                        rows: '3',
                        placeholder: 'Any issues, observations, or comments about today\'s operations...',
                        disabled: fieldsLocked
                    })
                ),
                
                // Management PIN Input (if updating)
                showPinInput && React.createElement('div', {
                    className: 'border border-yellow-400 bg-yellow-50 rounded-lg p-6'
                },
                    React.createElement('h3', {
                        className: 'text-lg font-semibold text-yellow-800 mb-4'
                    }, '🔐 Management Authorization Required'),
                    React.createElement('div', {
                        className: 'max-w-md'
                    },
                        React.createElement('label', {
                            className: 'block text-sm font-medium mb-1'
                        }, 'Enter Management PIN'),
                        React.createElement('input', {
                            type: 'password',
                            value: managementPin,
                            onChange: e => setManagementPin(e.target.value),
                            className: 'w-full p-3 border rounded focus:ring-2 focus:ring-yellow-500',
                            placeholder: 'Enter PIN to update existing entry',
                            maxLength: '20'
                        }),
                        React.createElement('p', {
                            className: 'text-sm text-yellow-600 mt-2'
                        }, 'PIN required to update entry for ' + selectedDate)
                    )
                ),
                
                // Submit Button
                React.createElement('div', {
                    className: 'flex justify-end space-x-4'
                },
                    showPinInput && React.createElement('button', {
                        type: 'button',
                        onClick: cancelUpdate,
                        className: 'bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600'
                    }, 'Cancel Update'),
                    React.createElement('button', {
                        type: 'submit',
                        disabled: loading || fieldsLocked || (showPinInput && !managementPin),
                        className: 'bg-olive-600 text-white px-8 py-3 rounded-lg hover:bg-olive-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2'
                    },
                        loading ? React.createElement(React.Fragment, null,
                            React.createElement('div', {
                                className: 'animate-spin rounded-full h-4 w-4 border-b-2 border-white'
                            }),
                            isUpdateMode ? 'Updating...' : 'Saving...'
                        ) : React.createElement(React.Fragment, null,
                            fieldsLocked ? 'Load Data First' : (isUpdateMode ? 'Update Entry' : 'Save Daily Entry'),
                            showPinInput && !managementPin && ' (PIN Required)'
                        )
                    )
                )
            )
        )
    );
}

window.DailyEntryTab = DailyEntryTab;
</script>