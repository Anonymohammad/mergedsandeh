<script type="text/babel">
function DailyEntryTab() {
  const [dailyItems, setDailyItems] = React.useState([]);
  const [selectedDate, setSelectedDate] = React.useState(new Date().toISOString().split('T')[0]);
  const [loading, setLoading] = React.useState(false);
  const [showPettyModal, setShowPettyModal] = React.useState(false);

  const [formData, setFormData] = React.useState({
    shawarmaStack: {
      starting_weight: '',
      remaining_weight: '',
      shaving_weight: '',
      staff_meals_weight: '',
      orders_weight: ''
    },
    inventory: {},
    sales: {
      total_revenue: '',
      shawarma_revenue: '',
      other_food_revenue: '',
      cash_sales: '',
      card_sales: '',
      delivery_aggregator_1: '',
      delivery_aggregator_2: '',
      petty_cash_total: '',
      pettyCashDetails: []
    },
    notes: ''
  });

  React.useEffect(() => {
    // Fetch daily items from the server when the form loads
    google.script.run
      .withSuccessHandler(res => {
        const items = JSON.parse(res);
        setDailyItems(items);
        setFormData(prev => ({
          ...prev,
          inventory: items.reduce((acc, it) => {
            acc[it.id] = { closing_quantity: '', notes: '' };
            return acc;
          }, {})
        }));
      })
      .withFailureHandler(err => console.error('Failed to load items', err))
      .getDailyItems();
  }, []);

  React.useEffect(() => {
    setFormData(prev => {
      const other = (parseFloat(prev.sales.total_revenue) || 0) - (parseFloat(prev.sales.shawarma_revenue) || 0);
      return { ...prev, sales: { ...prev.sales, other_food_revenue: other.toFixed(2) } };
    });
  }, [formData.sales.total_revenue, formData.sales.shawarma_revenue]);

  const handleInventoryChange = (id, field, value) => {
    setFormData(prev => ({
      ...prev,
      inventory: {
        ...prev.inventory,
        [id]: { ...prev.inventory[id], [field]: value }
      }
    }));
  };

  const addPettyEntry = () => {
    setFormData(prev => {
      const entries = [...prev.sales.pettyCashDetails, { category: '', description: '', amount: '', paid_by: '' }];
      const total = entries.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
      return { ...prev, sales: { ...prev.sales, pettyCashDetails: entries, petty_cash_total: total.toFixed(2) } };
    });
  };

  const updatePettyEntry = (idx, field, value) => {
    setFormData(prev => {
      const entries = [...prev.sales.pettyCashDetails];
      entries[idx] = { ...entries[idx], [field]: value };
      const total = entries.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
      return { ...prev, sales: { ...prev.sales, pettyCashDetails: entries, petty_cash_total: total.toFixed(2) } };
    });
  };

  const removePettyEntry = idx => {
    setFormData(prev => {
      const entries = [...prev.sales.pettyCashDetails];
      entries.splice(idx, 1);
      const total = entries.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
      return { ...prev, sales: { ...prev.sales, pettyCashDetails: entries, petty_cash_total: total.toFixed(2) } };
    });
  };

  const handleSubmit = e => {
    e.preventDefault();
    setLoading(true);
    const entryData = {
      date: selectedDate,
      shawarmaStack: { ...formData.shawarmaStack, revenue: formData.sales.shawarma_revenue },
      sales: formData.sales,
      inventory: formData.inventory,
      notes: formData.notes
    };
    google.script.run
      .withSuccessHandler(r => {
        const resp = JSON.parse(r);
        alert(resp.message);
        setLoading(false);
      })
      .withFailureHandler(err => {
        alert('Error saving entry: ' + err.message);
        setLoading(false);
      })
      .saveDailyEntry(entryData);
  };

  const renderInventory = () => {
    if (dailyItems.length === 0) return null;
    const groups = dailyItems.reduce((acc, it) => {
      (acc[it.category] = acc[it.category] || []).push(it);
      return acc;
    }, {});
    return Object.entries(groups).map(([cat, items]) => (
      <div key={cat} className="border border-gray-200 rounded-lg p-6">
        <h3 className="text-lg font-semibold text-gray-800 mb-4">{cat}</h3>
        <div className="overflow-x-auto">
          <table className="min-w-full border-collapse">
            <thead>
              <tr className="bg-gray-50">
                <th className="border border-gray-200 px-3 py-2 text-left text-xs font-medium text-gray-600">Item</th>
                <th className="border border-gray-200 px-3 py-2 text-left text-xs font-medium text-gray-600">Closing Qty</th>
                <th className="border border-gray-200 px-3 py-2 text-left text-xs font-medium text-gray-600">Notes</th>
              </tr>
            </thead>
            <tbody>
              {items.map(item => (
                <tr key={item.id} className="hover:bg-gray-50">
                  <td className="border border-gray-200 px-3 py-2 text-sm font-medium text-gray-700">{item.name}</td>
                  <td className="border border-gray-200 px-2 py-1">
                    <input
                      type="number"
                      step={item.unit === 'kg' ? '0.001' : '1'}
                      value={formData.inventory[item.id].closing_quantity}
                      onChange={e => handleInventoryChange(item.id, 'closing_quantity', e.target.value)}
                      className="w-full p-1 border rounded text-xs"
                      placeholder="0"
                    />
                  </td>
                  <td className="border border-gray-200 px-2 py-1">
                    <input
                      type="text"
                      value={formData.inventory[item.id].notes}
                      onChange={e => handleInventoryChange(item.id, 'notes', e.target.value)}
                      className="w-full p-1 border rounded text-xs"
                      placeholder="Optional"
                    />
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    ));
  };

  return (
    <form className="space-y-6" onSubmit={handleSubmit}>
      <div className="p-4 bg-blue-50 rounded-lg">
        <label className="block text-sm font-medium mb-1">Select Date</label>
        <input
          type="date"
          value={selectedDate}
          max={new Date().toISOString().split('T')[0]}
          onChange={e => setSelectedDate(e.target.value)}
          className="p-2 border rounded focus:ring-2 focus:ring-blue-500"
        />
      </div>

      <div className="border border-gray-200 rounded-lg p-6">
        <h3 className="text-lg font-semibold text-gray-800 mb-4">üçñ Shawarma Stack</h3>
        <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
          {['starting_weight','remaining_weight','shaving_weight','staff_meals_weight','orders_weight'].map(field => (
            <div key={field}>
              <label className="block text-sm font-medium mb-1">{field.replace(/_/g, ' ')} (kg)</label>
              <input
                type="number"
                step="0.001"
                value={formData.shawarmaStack[field]}
                onChange={e => setFormData(prev => ({
                  ...prev,
                  shawarmaStack: { ...prev.shawarmaStack, [field]: e.target.value }
                }))}
                className="w-full p-2 border rounded focus:ring-2 focus:ring-olive-500"
                required
              />
            </div>
          ))}
        </div>
      </div>

      {renderInventory()}

      <div className="border border-gray-200 rounded-lg p-6">
        <h3 className="text-lg font-semibold text-gray-800 mb-4">üí∞ Daily Sales</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">Total Daily Revenue (QAR)</label>
            <input
              type="number"
              step="0.01"
              value={formData.sales.total_revenue}
              onChange={e => setFormData(prev => ({
                ...prev,
                sales: { ...prev.sales, total_revenue: e.target.value }
              }))}
              className="w-full p-2 border rounded focus:ring-2 focus:ring-olive-500"
              required
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Shawarma Revenue (QAR)</label>
            <input
              type="number"
              step="0.01"
              value={formData.sales.shawarma_revenue}
              onChange={e => setFormData(prev => ({
                ...prev,
                sales: { ...prev.sales, shawarma_revenue: e.target.value }
              }))}
              className="w-full p-2 border rounded focus:ring-2 focus:ring-olive-500"
              required
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Other Food Revenue (QAR)</label>
            <input
              type="number"
              step="0.01"
              value={formData.sales.other_food_revenue}
              readOnly
              className="w-full p-2 border rounded bg-gray-100"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Cash Sales (QAR)</label>
            <input
              type="number"
              step="0.01"
              value={formData.sales.cash_sales}
              onChange={e => setFormData(prev => ({
                ...prev,
                sales: { ...prev.sales, cash_sales: e.target.value }
              }))}
              className="w-full p-2 border rounded focus:ring-2 focus:ring-olive-500"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Card Sales (QAR)</label>
            <input
              type="number"
              step="0.01"
              value={formData.sales.card_sales}
              onChange={e => setFormData(prev => ({
                ...prev,
                sales: { ...prev.sales, card_sales: e.target.value }
              }))}
              className="w-full p-2 border rounded focus:ring-2 focus:ring-olive-500"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Delivery Aggregator 1 (QAR)</label>
            <input
              type="number"
              step="0.01"
              value={formData.sales.delivery_aggregator_1}
              onChange={e => setFormData(prev => ({
                ...prev,
                sales: { ...prev.sales, delivery_aggregator_1: e.target.value }
              }))}
              className="w-full p-2 border rounded focus:ring-2 focus:ring-olive-500"
            />
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Delivery Aggregator 2 (QAR)</label>
            <input
              type="number"
              step="0.01"
              value={formData.sales.delivery_aggregator_2}
              onChange={e => setFormData(prev => ({
                ...prev,
                sales: { ...prev.sales, delivery_aggregator_2: e.target.value }
              }))}
              className="w-full p-2 border rounded focus:ring-2 focus:ring-olive-500"
            />
          </div>
        </div>
        <div className="mt-4">
          <label className="block text-sm font-medium mb-1">Petty Cash Total (QAR)</label>
          <div className="flex gap-2">
            <input
              type="number"
              step="0.01"
              value={formData.sales.petty_cash_total}
              readOnly
              className="w-full p-2 border rounded bg-gray-100"
            />
            <button
              type="button"
              onClick={() => setShowPettyModal(true)}
              className="bg-blue-600 text-white px-3 py-2 rounded"
            >
              Add
            </button>
          </div>
        </div>
      </div>

      <div className="border border-gray-200 rounded-lg p-6">
        <h3 className="text-lg font-semibold text-gray-800 mb-4">üìù Daily Notes</h3>
        <textarea
          value={formData.notes}
          onChange={e => setFormData(prev => ({ ...prev, notes: e.target.value }))}
          className="w-full p-3 border rounded focus:ring-2 focus:ring-olive-500"
          rows="3"
          placeholder="Any issues, observations, or comments about today's operations..."
        />
      </div>

      <div className="flex justify-end">
        <button
          type="submit"
          disabled={loading}
          className="bg-olive-600 text-white px-8 py-3 rounded-lg hover:bg-olive-700"
        >
          {loading ? 'Saving...' : 'Save Daily Entry'}
        </button>
      </div>

      {showPettyModal && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
          <div className="bg-white p-6 rounded-lg w-full max-w-lg space-y-4">
            <h3 className="text-lg font-semibold">Petty Cash Details</h3>
            {formData.sales.pettyCashDetails.map((entry, idx) => (
              <div key={idx} className="grid grid-cols-4 gap-2 items-end">
                <input
                  type="text"
                  placeholder="Category"
                  value={entry.category}
                  onChange={e => updatePettyEntry(idx, 'category', e.target.value)}
                  className="border p-1 rounded"
                />
                <input
                  type="text"
                  placeholder="Description"
                  value={entry.description}
                  onChange={e => updatePettyEntry(idx, 'description', e.target.value)}
                  className="border p-1 rounded"
                />
                <input
                  type="number"
                  step="0.01"
                  placeholder="Amount"
                  value={entry.amount}
                  onChange={e => updatePettyEntry(idx, 'amount', e.target.value)}
                  className="border p-1 rounded"
                />
                <input
                  type="text"
                  placeholder="Paid By"
                  value={entry.paid_by}
                  onChange={e => updatePettyEntry(idx, 'paid_by', e.target.value)}
                  className="border p-1 rounded"
                />
                <button
                  type="button"
                  onClick={() => removePettyEntry(idx)}
                  className="col-span-4 text-red-600 text-xs text-right"
                >
                  Remove
                </button>
              </div>
            ))}
            <div className="flex justify-between">
              <button
                type="button"
                onClick={addPettyEntry}
                className="bg-green-600 text-white px-3 py-2 rounded"
              >
                Add Entry
              </button>
              <button
                type="button"
                onClick={() => setShowPettyModal(false)}
                className="bg-gray-300 px-3 py-2 rounded"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
    </form>
  );
}
window.DailyEntryTab = DailyEntryTab;
</script>
